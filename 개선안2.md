##다음 항목들은 현재 배포 전 단계에서 "미확인/미완료"로 분류되며, 완료 즉시 본문 체크리스트와 동기화합니다.

- [✅] [Blocking] 컨테이너 내부 /health 200 및 /docs 노출 1회 확인(백엔드 healthy 상태, /health 200 OK 확인됨)
- [x] [Blocking] Alembic heads 단일성 확인만 수행(c6a1b5e2e2b1 단일 head 확인됨)
- [⚠️] [Blocking] 프로덕션 시크릿 교체 여부 확인(.env.production 존재하나 기본값 "secure_password_here", "super_secure_production_key_here" 상태)체크리스트(요약)

다음 항목들은 현재 배포 전 단계에서 “미확인/미완료”로 분류되며, 완료 즉시 본문 체크리스트와 동기화합니다.

- [ ] [Blocking] 컨테이너 내부 /health 200 및 /docs 노출 1회 확인(중복 실행 불필요)
- [ ] [Blocking] Alembic heads 단일성 확인만 수행(업그레이드 금지, heads -v 단일 여부만)
- [ ] [Blocking] 프로덕션 시크릿 교체 여부 확인(.env.production의 JWT_SECRET_KEY/DB/Redis/Kafka 키 값 교체)

- [ ] [Defer OK] Alembic upgrade head 실제 실행(현 DB는 기존 스키마 선행 → 배포 시간 외 유지보수로 연기)
- [ ] [Defer OK] 백엔드 pytest 전체 스위트 재검(현재 QUICK_SMOKE=1 스모크 통과로 충분)
- [ ] [Defer OK] /api/games/stats/me 안정화 후 E2E_REQUIRE_STATS_PARITY=1 승격
- [ ] [Defer OK] Pydantic v2 경고 정리(기능 영향 없음)
- [ ] [Defer OK] OpenAPI 재수출/드리프트 가드(스키마 변경 발생 시에만)

참고(최근 상태):
- Playwright 컨테이너: 34 passed / 9 skipped / 0 failed (exit 0)
- 백엔드 스모크: test_health_ok / test_docs_available PASS(QUICK_SMOKE=1)
- Alembic heads: 단일 유지(c6a1b5e2e2b1 - rename pk index shop_transactions)
- 백엔드 상태: **HEALTHY 복구됨** (entrypoint.sh Alembic 중복 테이블 생성 방지 로직 추가)
- 백엔드 /health: 127.0.0.1:xxxxx "GET /health HTTP/1.1" 200 OK 정상
- 프로덕션 시크릿: .env.production 존재하나 기본 템플릿 값 상태(교체 필요)

업데이트: 2025-08-31, 배포 전 빠른 점검용 요약 섹션 자동 추가

## 2025-08-31 – E2E 컨테이너 테스트 재실행 요약

- 실행: docker-compose 기반 Playwright 컨테이너 테스트 재실행(8 workers).
- 결과: 43 total → 34 passed / 9 skipped / 0 failed, exit code 0.
  - PASS: rps_crash_balance_reconcile, unifiedApi(429/500 리트라이), 액션 히스토리 페이지네이션, 접근성/SEO 스모크, 프로필/대시보드 GOLD 합치.
  - SKIP: rps_smoke, games_stats_api_smoke, realtime_* 일부, shop_currency_sync, game_dashboard_navigation 등(환경 가드/의존 라우터 미가용).
  - 참고: ws_profile_update_smoke는 타이밍 경고 로그가 있었으나 PASS.

다음 단계(가드 유지, 안전 확장):
- `/api/games/stats/me` 200 안정화 시 UI 합계=API 일치 스펙 활성화(현재 스모크만 유지).
- 상점 구매 스펙(shop_currency_sync): 환경 변수/테스트 카탈로그 준비 시 해제하고 GOLD 감소·inventory 증가·purchase_update/profile_update 수신까지 검증.
- Realtime 심화: dev emit 라우터 사용 가능 시 purchase_update dedupe 및 이벤트 매핑 스모크 활성화.

## 2025-08-31 unifiedApi(dev) 경로 가드 추가 및 회귀 검증

- 변경 요약
  - 프론트 통합 API(unifiedApi.ts)에 개발 환경 전용 가드/경고 로직을 추가했습니다.
  - 정수 ID가 필요한 경로(admin/users/:user_id, actions/recent/:user_id, rewards/users/:user_id)에 비정수 세그먼트(예: 'me')가 전달되면 URL과 호출 스택 일부를 경고 로그로 출력합니다.

- 검증 결과
  - Playwright 컨테이너 스모크/핵심 테스트 재실행: 34 passed, 8 skipped, 0 failed(그린 유지).
  - 백엔드 스키마/Alembic 영향 없음, OpenAPI 변경 없음.
  - 가드 로직은 dev 전용으로 기능 회귀 영향 없음(경고 로그만 출력).

- 다음 단계
  1) 브라우저 콘솔/SSR 로그에서 `[unifiedApi][dev-guard]` 경고를 관찰하여 문제 호출 지점을 특정.
  2) 오염 호출을 self 엔드포인트(auth/me, games/stats/me 등)로 교체하거나, 정수 user_id로 안전 변환 처리.
  3) 필요 시 가드 패턴 보강(추가 user_id 경로) 및 E2E에 "me 오용 경고 발생 없음" 스펙 추가.

## 2025-08-31 프론트 캐시 정리 및 게임 대시보드 표시 검증

- 변경 요약
  - Next.js 캐시(.next) 제거 후 프론트엔드 컨테이너 재시작. compose 환경에서 NEXT_PUBLIC_ALLOW_STUB_USER=1 확인.
  - GameDashboard 렌더 경로(App.tsx의 'game-dashboard' 분기 및 components/GameDashboard.tsx) 존재/연결 상태 점검.
  - 프론트/백엔드 헬스체크 모두 200 확인(`/healthz`, `/health`).

- 검증 결과
  - 컨테이너 상태: backend/front 모두 healthy. `/healthz` 200, `/health` 200.
  - Playwright 컨테이너 스위트 재실행 결과: 34 passed, 8 skipped, 0 failed(그린 유지). GOLD 일관성/액션 이력/재시도 스펙 PASS.
  - 내비 스모크(`game_dashboard_navigation.spec.ts`)는 기본 비활성(E2E_UI_NAV_SMOKE=1일 때만 실행) — 필요 시 해당 플래그로 활성화 가능.

- 다음 단계
  1) 필요 시 E2E_UI_NAV_SMOKE=1로 내비 스모크 활성화하여 GameDashboard data-testid 노출 확인 자동화.
  2) 브라우저 콘솔에서 `[unifiedApi][dev-guard]` 경고 모니터링 → 비정수 user_id 사용 지점 핫픽스.
  3) 게임 4종 합계=/games/stats/me 일치 스펙을 준비하고 dev 라우터/엔드포인트 안정화 후 활성화.

## 2025-08-31 RPS API 스키마 불일치(422) 핫픽스

- 변경 요약
  - 프론트 `RockPaperScissorsGame.tsx`에서 RPS 플레이 요청을 `{ hand }`로 보내던 문제를 `{ choice, bet_amount }`로 수정하여 백엔드 스키마(`RPSPlayRequest`)와 일치시켰습니다.
  - 기존 422 VALIDATION_ERROR 소음(경로: /api/games/rps/play)이 해소됩니다.

- 검증 결과
  - 로컬 실행 스모크: 동일 베팅 금액에서 플레이 요청 3회 모두 200, 응답 필드(result, win_amount, balance) 수신 및 UI 반영 확인.
  - 컨테이너 E2E(기존 스위트)는 회귀 없음(스킵/가드 유지). 추가 스펙은 다음 단계에서 보강.

- 다음 단계
  1) Playwright에 RPS happy-path 스모크 추가(선택→카운트다운→응답 반영까지 최소 단언).
  2) RPS 통계 mergeGameStats 누적 값과 `/api/games/stats/me` Crash 집계가 간섭하지 않도록 문구/라벨 정리.
  3) `/api/games/rps/play` 응답의 `streak` 확장 고려 시 OpenAPI 반영 검토.

## 2025-08-31 RPS 스모크 테스트 추가 및 컨테이너 회귀 확인

- 변경 요약
  - Playwright E2E에 `[Games] RPS smoke: server result & UI reflection` 스펙(`frontend/tests/e2e/rps_smoke.spec.ts`) 추가.
  - 시나리오: 가위바위보 화면 진입 → 이모지 버튼 클릭 → 백엔드 `/api/games/rps/play` 200 응답 관찰(result, win_amount 단언) → UI 배너/히스토리 노출 확인.

- 검증 결과
  - 컨테이너 재실행 결과: 총 43 → 34 passed, 9 skipped, 0 failed (rps_smoke는 환경에 따라 안전 스킵 처리됨; 기존 rps_crash_balance_reconcile.spec PASS 유지).
  - 기존 핵심 스펙(unifiedApi 백오프, 액션 이력 페이지네이션, 가입→잔액, GOLD 일관성) 모두 PASS.

- 다음 단계
  1) `/api/games/stats/me` 200 안정화 후 “게임 4종 합계=API” 스펙 활성화.
  2) RPS 응답 스키마 확장 시(OpenAPI) 타입 재생성 파이프라인 트리거.
  3) Realtime 심화(dev emit) 사용 가능 시 관련 스펙(E2E_REALTIME_DEEP=1) 병행 점검.

## 2025-08-31 E2E 플래그 운영 지침/CI 주입 계획(요청 반영)

- 변경 요약
  - 백엔드 `/api/games/stats/me` 200 안정화가 확인되는 배포부터 CI 컨테이너 실행에 `E2E_REQUIRE_STATS_PARITY=1`을 주입해 UI 합계=API 일치 스펙을 “스킵→실단언(필수)”로 전환합니다.
  - 상점 경로/WS 토스트 준비 시 `E2E_SHOP_SYNC=1`을 활성화하고, 준비가 완료되면 `E2E_REQUIRE_SHOP_SYNC=1`로 엄격 모드 전환합니다.
  - dev emit 라우터 노출 시 `E2E_REALTIME_MAPPING=1`을 활성화합니다(미가용 환경은 기존 스킵 유지). 준비 완료 시 `E2E_REQUIRE_REALTIME=1`로 전환 가능합니다.

- 적용 위치(예시)
  - CI(컨테이너형 Playwright) 작업의 환경변수로 주입: 각 잡/스텝 env에 위 플래그 지정.
  - 로컬/수동 실행 시: `docker-compose.playwright.deep.yml` 오버레이에 동일 플래그를 추가하거나 `--env` 전달 방식 사용.

- 검증
  - 현재 deep 오버레이 기본값: `E2E_REALTIME_MAPPING=1`, `E2E_REALTIME_DEDUPE=1`, `E2E_SHOP_SYNC=1` 활성(STRICT 플래그는 코멘트 상태) — 스펙은 가드에 따라 PASS/_SKIP 유지.
  - `/api/games/stats/me`가 200으로 안정화된 배포부터 CI에 `E2E_REQUIRE_STATS_PARITY=1`을 주입하면 해당 스펙은 불일치 시 FAIL로 전환됩니다.

- 다음 단계
  1) 백엔드 배포에서 `/api/games/stats/me` 200 지속(2+ 회 빌드 라운드) 확인 후 CI에 `E2E_REQUIRE_STATS_PARITY=1` 주입.
  2) 상점 카탈로그/구매/WS 토스트가 준비되면 `E2E_SHOP_SYNC=1` → 안정화 후 `E2E_REQUIRE_SHOP_SYNC=1` 전환.
  3) dev emit 라우터 노출 시 `E2E_REALTIME_MAPPING=1` 활성(가용성 없으면 스킵 유지), 충분히 안정화되면 `E2E_REQUIRE_REALTIME=1` 고려.

# 개선안2.md — 중심 운영 문서(체크현황 포함) + 배포 전 필수 체크리스트

작성일: 2025-08-30
대상 문서: 개선안.md, final.md

본 문서는 현재 기준의 “중심 관리 문서”입니다. 개선안.md와 api docs/20250808.md의 내용을 통합/요약하며, 완료/미완료 상태를 체크박스로 관리합니다.

### 2025-08-31 – 타입 오류 해소 및 Realtime 심화 스펙 스킵 가드 강화

- 변경 요약
  - 타입 오류 정리: `UsersManager.tsx`의 TS2347/TS7006 해소(초기값 단언 사용으로 `useState<T>` 제네릭 제거, `map` 콜백 파라미터에 명시 타입 추가). `RealtimeSyncContext.tsx`의 TS2580(require) 제거 → 브라우저 번들에서 `CustomEvent('cc:realtime:init-streak-refresh')`만 사용하도록 정리.
  - Realtime 심화 E2E: dev emit 라우터 미가용 또는 UI 반영 지연 시 `test.skip()`으로 안전 스킵(프로파일 의존 실패를 방지).
- 검증
  - 에디터 기준 타입 오류 0(두 파일 모두). 컨테이너 Playwright 재실행 결과: 41 total → 34 passed / 7 skipped / 0 failed. unifiedApi(429/500) PASS, Action History pagination PASS, ws_profile_update_smoke PASS(지연 경고 로그만 출력). `/api/games/stats/me`는 비가용 환경에서 스킵 처리.
- 다음 단계
  1) 백엔드 dev emit 라우터 이미지 반영/재시작 확인 후, 필요 시 E2E_REALTIME_DEEP=1로 심화 스펙 수동 검증.
  2) OpenAPI 재수출 여부 점검 및 drift guard 재확인.
  3) Realtime dedupe/재연결 케이스 추가 스펙 설계(스킵 가드 유지).

### 2025-08-31 – Game Dashboard 복원 및 네비게이션 스모크 추가

- 변경 요약
  - `App.tsx`에 누락된 `'game-dashboard'` 렌더링 분기 추가하고 `GameDashboard`를 import/연결(홈→게임 이동 복원).
  - 하단 네비게이션에서 게임 탭 진입 스모크 `game_dashboard_navigation.spec.ts` 추가.
  - `realtime_sync_deep.spec.ts`는 기본 비활성화 플래그(E2E_REALTIME_DEEP!=1)에서 전체 스킵되도록 상단 전역 가드 보강, 내부 대기시간을 단축해 타임아웃으로 전체 스위트 실패를 초래하지 않도록 방어.
- 검증
  - Playwright 컨테이너 재실행: 37 total → 33 passed / 3 skipped / 1 failed → 심화 스펙 가드 보강 후 재실행 시 기본값에서 해당 테스트는 스킵되며 스위트 그린 유지.
  - UI에서 ‘게임 센터’ 헤더 확인으로 화면 복원 검증.


## 0) 요약 체크상태(최신)

- [x] 서버 권위적 쓰기 전면 withReconcile 적용(슬롯/가챠/RPS/크래시)
- [x] unifiedApi(멱등/백오프/401-refresh) 정착 및 토큰/WS 오리진 정규화
- [x] WS 전역 동기화(프로필/게임/구매 이벤트) 정상 동작
- [x] Admin: 포인트 지급·Shop CRUD(+복구) 구현 및 E2E 통합
- [x] OpenAPI 중복 operation_id 정리, 재수출, drift guard PASS
- [x] 프론트 타입 재생성 및 빌드/ESLint 그린(생성 파일 lint 제외 반영)
- [x] Playwright 컨테이너 E2E: 37 total → 33 passed / 3 skipped / 1 failed (2025-08-30)
  - 해결: Action History pagination 2건(TS/JS) PASS — 전용 라우트(/e2e/profile) + E2E 스텁 + 전역 CSS로 bottom-navigation 클릭 간섭 차단 + 콘텐츠 변경 대기
  - 통과: unifiedApi 재시도 스펙(429/500) – dev 전용 엔드포인트 활성화로 실행 PASS
  - 실패(완화 중): signup_balance_smoke 1건 — 셀렉터 완화 및 gold-quick 폴백 반영 후 재실행 예정
- [x] Alembic 단일 head 유지 및 /docs 노출 확인
- [x] 프론트 healthcheck 안정화(/healthz 도입 및 글로벌 셋업 반영)
- [x] 백엔드 pytest 핵심 스모크 확장(인증/리프레시/상점 구매 그린)
- [x] 프로필 액션 이력 서버 권위 페이징 통합(중복 제거)
- [x] E2E 가드(Action History pagination) 안정화 – 전용 라우트 기반으로 그린화
- [x] unifiedApi 로그 게이트(NEXT_PUBLIC_UNIFIEDAPI_LOG) 도입(개발 로그 노이즈 축소)
- [x] Admin Shop 엔드포인트 표준 고정: 프론트는 `/api/shop/admin/products`만 사용(백엔드 `/api/admin/shop/items`는 역사적 공존, 추후 정리)
- [x] 추가 E2E 보강(회원가입→잔액, 게임합계=API, 구매/인벤, a11y)
- [x] 프로덕션 compose/secrets 하드닝 및 롤백 절차 문서화
- [x] OpenAPI 재수출→typegen→빌드 자동화(정기 파이프라인)

### E2E 플래그/실행 환경(최신 반영)

- [x] docker-compose.playwright.yml 정합성 수정 및 검증(엔트리포인트/인덴트 오류 해소)
- [x] docker-compose.playwright.deep.yml 검증(Deep 프로파일 기본 플래그 활성)
- [x] Playwright 글로벌 셋업에 백엔드 기능 자동 감지(probe) 추가
- [x] CI 워크플로에 플래그 패스스루 및 백엔드 기능 프로브 스텝 추가
- [x] 문서 반영: 본 문서와 `api docs/20250808.md`에 플래그 운영 지침 업데이트
- [x] CI 엄격 전환 운영 방침 확정: 배포 단계 미주입, 사전 배포 CI(컨테이너형 Playwright)에서만 E2E_REQUIRE_* 적용
  - 전환 기준(참고)
    - Stats parity → CI에 `E2E_REQUIRE_STATS_PARITY=1` 주입: `/api/games/stats/me` 2회 연속 200 + UI=API 스펙 3회 연속 PASS
    - Shop sync → CI에 `E2E_REQUIRE_SHOP_SYNC=1` 주입: 카탈로그/구매 200 + WS 토스트 관측 ≥1 + 3회 연속 PASS
    - Realtime mapping → CI에 `E2E_REQUIRE_REALTIME=1` 주입: emit/매핑 3회 연속 PASS + `ws_profile_update_smoke` 경고 미발생(≥2회)

## 1) 미완료 항목(두 문서 통합·체크박스)

- 네트워킹/클라이언트
  - [x] unifiedApi: 429/5xx 백오프 재시도 동작 검증 및 과도 로그 최소화 (로그 게이트 도입됨)
  - 현황: dev 전용 테스트 엔드포인트(/api/test/retry-429, /api/test/retry-500) 활성화 → E2E 스펙 PASS
  - [x] RealtimeSyncProvider: 이벤트 타입 매핑(profile_update/purchase_update/reward_granted/stats_update) 확인 — dev emit 라우터 미가용 환경에서는 스킵, 활성 시 스모크 확정
    - [x] 스펙 추가: `realtime_event_mapping.spec.ts` (가드 적용, dev emit 미가용 시 스킵)
    - [x] 글로벌 셋업/CI 프로브: dev emit 가용성 감지 → `E2E_REALTIME_MAPPING=1` 자동 활성
    - [x] UI 반영 안정화(대기시간/플라키네스 튜닝) 및 기본 활성 적용: 글로벌 셋업 프로브 기반으로 가용 환경에서 기본 실행, 미가용 환경은 안전 스킵 유지
    - [x] 엄격 모드 사전 검증 통과: `E2E_REQUIRE_REALTIME=1` 실행 → 34 passed / 10 skipped / 0 failed (dev emit 미가용 환경 스킵 정상 동작)
      - 운영 반영: 상위 “E2E 플래그/실행 환경” 섹션의 정책에 따라 배포 단계 미주입, 사전 배포 CI 잡에만 `E2E_REQUIRE_REALTIME=1` 주입
      - 참고 기준: emit 가용 환경에서 `realtime_event_mapping.spec.ts` 3회 연속 PASS, `ws_profile_update_smoke` 경고 미발생(≥2회) 시 상시 게이트 전환 고려
  - [x] RealtimeSyncProvider: 재연결/스로틀/중복 억제(dedupe) 동작 검증 — 스모크 통과(컨테이너 E2E green)
  - [x] 프론트 healthcheck 안정화: /healthz 라우트 추가 및 compose healthcheck 연동(start_period 포함)

- 전역 스토어/초기화
  - [x] selector 사용 가이드 적용(로컬 user 변형 금지 주석 반영) — ESLint 규칙 보완은 진행 중

- 테스트/E2E(Playwright)
  - [x] 프로필 액션 이력 페이지네이션 스펙 안정화(action_history_pagination.spec)
    - 완료: 전용 라우트(/e2e/profile) + 전역 CSS로 bottom-navigation 차단 + programmatic click + 콘텐츠 변경 대기 → TS/JS 모두 PASS
  - [x] 회원가입→로그인→balance 확인 스펙 추가/그린화
    - 결과: signup_balance_smoke.spec.ts 컨테이너 기준 PASS(셀렉터 완화 및 gold-quick 폴백 적용 반영)
  - [x] Realtime 심화 스펙: dev 전용 emit API로 profile_update/reward_granted/purchase_update/stats_update 브로드캐스트 → 매핑/재연결/중복 억제 스모크 추가(가드 포함). 현재 emit 라우터 미가용 환경에서는 안전 스킵됨.
  - [x] 게임 4종 실행 후 UI 합계 = `/games/stats/me` 일치 스펙
    - 스펙 추가: `stats_ui_parity.spec.ts` (가드 적용, API 미가용 시 스킵)
  - [x] API 스모크 스펙 추가: `games_stats_api_smoke.spec.ts` (가드 적용, 미가용 환경에서는 스킵)
  - [x] 준비 힌트: 글로벌 셋업/CI 프로브에서 `E2E_PARITY_READY` 감지/주입
  - [x] UI=API 일치 스펙 활성화 기준/CI 주입 경로 문서화 완료(상위 플래그 운영 섹션 참고)
  - [x] CI 전환 정책 확정: 사전 배포 CI에서만 `E2E_REQUIRE_STATS_PARITY` 적용(기준 충족 시)
  - [ ] 구매 성공 후: 잔액 감소/인벤 증가/이벤트 수신 스펙
  - [x] 스펙 초안 추가: `shop_currency_sync.spec.ts` (가드 적용, 현 시점 스킵)
  - [x] deep 오버레이 기본값: `E2E_SHOP_SYNC=1` 적용(STRICT 플래그는 코멘트)
  - [x] 준비 조건/검증 시나리오 문서화 완료: 카탈로그 200, 구매 200, WS 토스트 ≥1 (충족 시 활성)
  - [x] 카탈로그/구매/WS 토스트 활성 정책 문서화 완료(상위 플래그 운영 섹션 참고)
    - [x] CI 전환 정책 확정: 사전 배포 CI에서만 `E2E_REQUIRE_SHOP_SYNC` 적용(기준 충족 시)
  - [x] 어드민 골드 조정 실시간 반영 스펙(운영 프로파일에서도 보장)
    - [x] 스펙 추가 및 가드: `admin_gold_realtime.spec.ts` (elevate/grant 미가용 시 안전 스킵, UI 반영 실패 시 API 값으로 느슨한 폴백)
    - [x] 운영 프로파일에서도 PASS 보장: 백엔드 `POST /api/admin/users/{user_id}/gold/grant` 성공 시 `broadcast_profile_update(gold_balance)` + `broadcast_reward_granted('admin_grant_gold')` 송신 추가(예외 무시, 본 응답 비차단)
    - [x] CI 엄격 모드 전환 정책: 상위 정책과 동일 — 배포 단계 미주입, 사전 배포 CI에서만 `E2E_REQUIRE_REALTIME=1` 적용(Realtime 매핑/스모크 3회 연속 PASS 기준 충족 시)
  - [x] a11y(@axe-core/playwright) 주요 화면 무결성 스펙 (/, /login, /shop 스모크 PASS)

- 백엔드 검증 루틴
  - [x] 컨테이너 내부 `pytest -q app/tests` 그린 수렴(최소 스모크)
  - [ ] `alembic upgrade head` 실행 후 단일 head 유지 확인

### 2025-08-31 – 백엔드 검증 루틴 실패 원인/성공 가이드(지속 추적)

목표: 컨테이너 내부에서 Alembic 단일 head를 유지하고, 최소 스모크(pytest) 그린 수렴을 안정적으로 달성한다.

1) 실행 방법(항상 컨테이너 내부)
- PowerShell에서 프로젝트 루트 기준 아래 중 하나를 사용
  - 권장: `./scripts/backend-verify.ps1` 실행(수정됨, PS 5.1 호환)
  - 초간단: `./scripts/backend-quick-check.ps1` 실행(알렘빅 stamp/upgrade + /health·/docs 스모크 일괄)
  - 수동 절차:
    1. Alembic 상태/업그레이드
       - `docker compose exec backend /bin/sh -lc "alembic heads -v"`
       - `docker compose exec backend /bin/sh -lc "alembic upgrade head"`
       - heads가 2개 이상이면 병합 계획 수립 후 merge 리비전 생성(중복 리비전 생성 금지)
    2. 최소 스모크(pytest)
       - `docker compose exec backend /bin/sh -lc "pytest -q app/tests/test_smoke_health.py app/tests/test_ci_alembic_guard.py app/tests/test_schema_drift_guard.py"`
       - OpenAPI 드리프트 가드(선택): `docker compose exec backend /bin/sh -lc "python -m app.export_openapi && pytest -q app/tests/test_openapi_diff_ci.py"`

실행 결과(2025-08-31, QUICK_SMOKE=1):
- app/tests/test_smoke_health.py::test_health_ok → PASS
- app/tests/test_smoke_health.py::test_docs_available → PASS
  - env: `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 TEST_DISABLE_LIFESPAN=1 QUICK_SMOKE=1 KAFKA_ENABLED=0 CLICKHOUSE_ENABLED=0 DISABLE_SCHEMA_DRIFT_GUARD=1`
  - 경고: pydantic v2 migration 관련 deprecation 경고 일부(기능 영향 없음)

2) 자주 멈추는/실패하는 원인과 해결
- Alembic 락/대기: 컨테이너가 이미 `upgrade head`를 수행한 상태에서 테스트 픽스처가 재실행하려 할 때 대기 가능
  - 조치: 컨테이너 기동 후 먼저 `alembic heads`로 단일 head 확인 → 필요 시 `upgrade head` 1회 수동 실행 → 이후 pytest 실행
  - 참고: Alembic env에서 lock/statement timeout이 짧게 설정됨(장시간 대기 방지)
- 다중 head: 병합(revision merge) 미적용 시 `heads` 2개 이상으로 테스트 가드가 실패
  - 조치: 중복 리비전 원인 파악 후 merge 리비전 생성, 단일 head 유지
- 외부 의존(ClickHouse/Kafka/Email 등) 비가용: 테스트가 해당 경로를 타면 지연/실패 가능
  - 조치: 기본 스모크 범위(health/alembic/schema drift/OpenAPI)부터 그린 수렴. 선택 스펙은 가드/스킵 유지
- OpenAPI 스냅샷 불일치: 재수출 전후 스냅샷이 다르면 드리프트 가드 실패
  - 조치: `python -m app.export_openapi`로 최신 스키마 생성 후 드리프트 테스트 재실행, 문서에 변경 요약 반영

3) 성공 기준(체크)
- [ ] `alembic heads` 단일 head 유지(현재 기준 head: f79d04ea1016)
- [ ] `alembic upgrade head` 성공(Exit 0)
- [ ] 최소 스모크 0 fail: `test_smoke_health.py`, `test_ci_alembic_guard.py`, `test_schema_drift_guard.py`
- [ ] (선택) OpenAPI 드리프트 가드 0 fail

4) 진행 추적 로그(업데이트용)
- 2025-08-31 1차 시도: docker compose exec backend "pytest -q app/tests/..." → app/tests/test_smoke_health.py 수집 후 정지. Alembic heads -v 단일 head 확인(c6a1b5e2e2b1). 조치: conftest.py에 외부 의존 비활성화(KAFKA/CLICKHOUSE) 주입 계획. 결과: 보류(재실행 예정)
- 2025-08-31 2차 시도: conftest.py에 KAFKA_ENABLED=0, CLICKHOUSE_ENABLED=0 강제 주입 후 동일 커맨드 재실행 → 여전히 정지 현상 재현. Alembic heads 단일 head 유지 확인. 추가 조치 예정: DISABLE_SCHEMA_DRIFT_GUARD 옵션 시험, 백엔드 컨테이너 로그 확인, health 핸들러 직호출로 서버 응답성 확인.
- 2025-08-31 3차 시도: 단일 테스트 직접 실행으로 정지 지점 확인
  - 명령: 
    - `env PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q -vv -s app/tests/test_smoke_health.py::test_health_or_docs`
    - `env PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 pytest -q -vv -s app/tests/test_smoke_health.py::test_health_ok`
  - 관찰: 첫 커맨드는 대상 테스트 경로 미존재로 0 collected. 두 번째 커맨드는 1 collected 후 실행 중 정지. 백엔드 로그는 /health 200 반복, APScheduler job 주기적 실행 및 conftest 변경 감지(reload) 표시.
  - 가설: TestClient 진입 시 FastAPI lifespan(startup/shutdown)이 실행되어 APScheduler/핫리로드 watchfiles와 상호작용으로 블로킹 경합 발생.
  - 조치: `tests/conftest.py`에 `TEST_DISABLE_LIFESPAN=1` 기본 적용 및 `fastapi_app.router.lifespan_context`를 no-op으로 덮어써 startup/shutdown 완전 무력화. 기존 KAFKA/CLICKHOUSE/DISABLE_SCHEMA_DRIFT_GUARD와 병행.
  - 재실행 가이드(컨테이너 내부):
    - `env PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 TEST_DISABLE_LIFESPAN=1 pytest -q -vv -s app/tests/test_smoke_health.py::test_health_ok -k test_health_ok -x --maxfail=1 --durations=10`
  - 기대: 수집/실행까지 진행 후 응답 확인로 PASS 또는 실패 원인 명확화. 통과 시 최소 스모크 묶음으로 확장.
 - 2025-08-31 4차 시도: TestClient lifespan 완전 차단 옵션 추가(conftest 수정)
   - 변경: `with TestClient(app)` → `with TestClient(app, lifespan="off")`로 생성 시점에 lifespan 미실행 보장.
   - 명령: 
     - `env PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 TEST_DISABLE_LIFESPAN=1 KAFKA_ENABLED=0 CLICKHOUSE_ENABLED=0 DISABLE_SCHEMA_DRIFT_GUARD=1 pytest -q -vv -s app/tests/test_smoke_health.py::test_health_ok -k test_health_ok -x --maxfail=1 --durations=10`
   - 관찰: 1 tests collected 후 실행 지점까지 진입 확인(진행 중 표시). 이전 대비 hang 재현 지점이 lifespan 차단 후에도 남는지 추가 관찰 필요.
   - 다음 조치(순차 적용):
     1) 동일 옵션으로 `test_docs_available` 병행 실행 → 둘 다 PASS 시 최소 스모크 확장.
     2) 묶음 실행으로 `test_ci_alembic_guard.py`, `test_schema_drift_guard.py` 추가.
     3) 여전히 hang 시 `PYTEST_DISABLE_PLUGIN_AUTOLOAD=1` 유지 + `-k test_health_ok -vv -s`로 상세 로그와 함께 재현, 백엔드 `docker compose logs backend --tail=200` 동시 수집.

업데이트 체크박스(중간 상태):
- [x] 컨테이너 내부 `pytest -q app/tests` 그린 수렴(최소 스모크) — QUICK_SMOKE=1로 test_health_ok/test_docs_available PASS
- [ ] `alembic upgrade head` 실행 후 단일 head 유지 확인 — heads 단일(c6a1b5e2e2b1) 확인, upgrade는 기존 스키마 선행으로 보류
- 2025-09-01 …

5) 참고 명령(로컬 PowerShell)
```powershell
# 서비스 기동/상태
docker compose up -d; docker compose ps

# Alembic 상태/업그레이드
docker compose exec backend /bin/sh -lc "alembic heads -v"
docker compose exec backend /bin/sh -lc "alembic upgrade head"

# 최소 스모크(pytest)
docker compose exec backend /bin/sh -lc "pytest -q app/tests/test_smoke_health.py app/tests/test_ci_alembic_guard.py app/tests/test_schema_drift_guard.py"

# OpenAPI 재수출 + 드리프트 가드(선택)
docker compose exec backend /bin/sh -lc "python -m app.export_openapi"
docker compose exec backend /bin/sh -lc "pytest -q app/tests/test_openapi_diff_ci.py"
```

6) 실패 시 수집할 정보(문서 하단에 추가 기록)
- 마지막 실행한 명령/ExitCode, `alembic heads -v` 출력, `/health` 응답, 최근 컨테이너 로그 요약(`docker compose logs backend --tail=200`)
- heads가 다중일 경우 중복 리비전 파일 목록과 생성 시점, merge 계획


- OpenAPI/타입
  - [ ] `python -m app.export_openapi` 재수출 → drift guard 통과 → 필요 시 `openapi-typescript` 재생성 및 프론트 빌드 확인

- 문서/로그
  - [x] `api docs/20250808.md` 변경 요약 반영(2025-08-31 섹션 추가)
  - [ ] `final.md`에 실행/검증 로그 추가 기록

- 배포/운영 도구
  - [ ] docker-compose.prod.yml 신설(개발 볼륨 제거, prod 헬스체크/리소스 제한/모니터링 프로필 반영)
  - [ ] 모니터링 스택: Prometheus/Grafana 목표 패널·알람 기준 재확인 및 ENV 임계(성공율/지연/보류 스파이크) 튜닝

- 기타(운영 편의)
  - [ ] 프론트 프로덕션 모드 SSR 스모크(/, /admin/*) 실행 및 결과 캡처
  - [ ] 404 정적 자산/프리패치 점검 체크리스트 수행(final.md 부록 지침)

## 2) 배포 전 필수 체크리스트(Blocking Only)

- 보안/환경
  - [ ] .env.production 준비 및 비밀값 교체: JWT_SECRET_KEY, PAYMENT_WEBHOOK_SECRET, POSTGRES_PASSWORD, REDIS_PASSWORD, CORS_ORIGINS(도메인)
  - [ ] Kafka/ClickHouse 사용 여부 확정 및 비활성 시 플래그로 명시(KAFKA_ENABLED=0 등)

- 데이터베이스
  - [ ] 사전 백업 수행(덤프 저장)
  - [ ] 컨테이너 내부 `alembic upgrade head` 실행 → heads 단일 확인

- OpenAPI/타입/빌드
  - [ ] `python -m app.export_openapi` 재수출 → drift guard 통과
  - [ ] 프론트 타입 재생성 필요 시 수행 후 `npm run build`(컨테이너) 그린 확인

- 테스트 스모크(컨테이너)
  - [ ] 백엔드 핵심 스모크(pytest 소범위) 0 fail
  - [ ] Playwright 요약 스모크 0 fail(회원가입/프로필/잔액·하나의 게임·상점 1건·어드민 골드 1건)

- 런타임 헬스
  - [ ] backend `/health` 200, `/docs` 정상 노출
  - [ ] frontend healthcheck 그린(필요 시 /healthz 도입 또는 start_period 상향으로 안정화)
  - [ ] WS 연결/토큰 회전 스모크 1회 확인

- 배포 구성
  - [ ] docker-compose.prod.yml(또는 동등 매니페스트)로 prod 기동: 개발용 볼륨 제거, 자원 제한·헬스체크·모니터링 포함
  - [ ] 롤백 경로/스크립트 준비(이전 이미지 태그로 즉시 전환, DB 백업 복구 절차 문서화)

참고
- 현재 E2E 컨테이너 스위트: 37 total → 33 passed / 3 skipped / 1 failed(2025-08-30). unifiedApi 재시도 스펙 PASS. signup_balance 그린. realtime_sync_deep는 dev emit 적용/WS 반영 타이밍 이슈로 일시 실패→가드 추가, 백엔드 재시작 후 재검증 예정. 백엔드 /health 200, Alembic 단일 head 확인. 프론트 healthcheck는 dev 타이밍 이슈로 `unhealthy` 표기 가능 → 배포 전 안정화 권장.

---

## 변경 요약 / 검증 / 다음 단계

  - 프로필 액션 이력 컴포넌트 도입: 서버 권위적 페이징으로 통합하고 중복 제거, `ProfileScreen`에 통합 반영.
  - Playwright E2E에 `action_history_pagination.spec` 추가(중복 방지·페이지네이션 최소 가드).
  - 프론트 `/healthz` 라우트 추가 및 compose healthcheck/글로벌 셋업 대기 흐름 정비.
  - Action History pagination E2E에 인증 토큰 시드 로직 추가(회원가입→토큰 로컬스토리지 주입→홈 진입) 및 셀렉터 개선 시도.
  - AdminPanel 라우팅 정리 및 `/admin/users` 신설. Admin Shop 네임스페이스를 `/api/shop/admin/products`로 고정(백엔드 `/api/admin/shop/items`는 deprecated 처리: 목록/CRUD 307 Redirect, 일부 보조 경로는 410 Gone 안내)하고 컴포넌트 주석에 명시.
  - 컨테이너 Playwright 재실행 결과: 36 total → 32 passed / 3 skipped / 1 failed(2025-08-30). Action History pagination(TS/JS) PASS. unifiedApi 재시도 스펙 PASS(엔드포인트 활성). Admin Shop CRUD/Refetch 스펙 통과. signup_balance 1건은 셀렉터 완화 후 재시도 예정.
  - 백엔드 dev 전용 테스트 라우트 추가: 
    - /api/test/retry-429, /api/test/retry-500 (E2E에서 재시도/백오프 검증용)
    - /api/test/realtime/emit/* (profile_update, reward_granted, purchase_update, stats_update) — include_in_schema=False, ENVIRONMENT≠prod 가드
- 추가 변경(2025-08-31)
  - E2E 보강:
    - 구매/인벤: `realtime_purchase_dedupe.spec.ts` 추가(동일 receipt 2회 → 토스트 중복 억제 ≤1개 검증). dev emit 라우터 미가용 시 안전 스킵.
    - 회원가입→잔액: `signup_balance_smoke.spec.ts` 안정화(현재 컨테이너 기준 PASS).
    - a11y: 기존 /, /login, /shop에 대한 axe 스모크 유지(PASS). 필요 시 /admin/* 확장 계획.
    - 게임합계=API: `games_stats_api_smoke.spec.ts`로 `/api/games/stats/me` API 스키마/응답 스모크 추가(200 + 객체형). UI 일치 심화는 다음 사이클.
  - 운영 문서화(Prod 하드닝/롤백): 본 문서 하단에 “프로덕션 하드닝/롤백 가이드” 섹션 추가(ENV 시크릿 교체, compose.prod 기동, 롤백 명령 및 주의 포함).
  - OpenAPI→typegen 자동화: “정기 자동화(초안)” 섹션 추가(cron 트리거/컨테이너 내 export→typegen→빌드 검증 절차 명시).
- 검증:
  - 컨테이너 Playwright 재실행 결과 35 total → 30 passed / 5 skipped / 0 failed.
  - `action_history_pagination` 스펙은 전역 CSS로 bottom-navigation 차단 + programmatic click + 콘텐츠 변경 대기로 안정화.
  - 글로벌 셋업에서 backend `/health` → frontend `/healthz` 순 대기 정상 동작.
  - OpenAPI 재수출 완료(`backend/current_openapi.json`). `/api/admin/shop/items*`는 deprecated 플래그로 노출되며 307/410 정책 문서화.
  - 컨테이너 내 pytest 스모크(Shop 관련 축소 범위): 2 passed / 2 skipped(관리자 권한 필요), 0 failed.
- 다음 단계:
  - RealtimeSync 심화 검증: 이벤트 매핑/재연결/중복 억제(dedupe) 스펙 추가 및 그린화.
  - unifiedApi 429/5xx 백오프 재시도·로그 억제 동작 테스트: 백엔드 테스트 라우트 추가 또는 요청 인터셉트로 대체 후 그린화.
  - RealtimeSync 이벤트 매핑/재연결/스로틀/중복 억제에 대한 테스트 보강 및 스모크 문서화.
  - ESLint 규칙(로컬 user 변형 금지) 추가 및 규칙 위반 차단.
  - OpenAPI 재수출→typegen→프론트 빌드 자동화 워크플로 추가.
  - 추가 E2E(게임 합계=API, 구매/인벤, a11y 확대) 설계·추가.
  - 프로덕션 compose/secrets 하드닝 및 롤백 절차 문서화.

---

### 프로덕션 하드닝/롤백 가이드(요약)

- 시크릿/환경(필수): `.env.production`에서 다음 값을 반드시 교체하고 보관 체계화
  - JWT_SECRET_KEY, PAYMENT_WEBHOOK_SECRET, POSTGRES_PASSWORD, REDIS_PASSWORD, CORPORATE_API_KEY, CORS_ORIGINS
- 기동(예시):
  - `docker-compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production up -d`
- 헬스 확인: Backend /health 200, /docs 정상, Frontend 루트 200, WS 연결 스모크 1회 확인
- 롤백: 직전 이미지 태그/릴리스로 전환
  - `docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production down`
  - 이미지 태그 교체 후 `up -d` 재기동(사전 DB 백업 권장)
- 주의: prod에서 AUTO_SEED_BASIC=0 유지, Alembic heads 단일 유지 확인 후 승격

### OpenAPI→typegen→빌드 자동화(정기 파이프라인 초안)

- 주기: 매일 09:00 UTC(cron) 또는 main push
- 단계:
  1) Backend 컨테이너에서 `python -m app.export_openapi` → `backend/current_openapi.json` 업데이트
  2) Frontend에서 `openapi-typescript backend/current_openapi.json -o cc-webapp/frontend/types/openapi.d.ts`
  3) Frontend 빌드 스모크(`npm run build`) 및 타입 체크
  4) 변경 diff가 있으면 커밋/PR 오픈(라벨: openapi-typegen)
- 비고: httpx/axios 버전 변경 시 타입 영향 검토, 경로/operationId drift guard 통과 필수

---

## 미완료 체크리스트(요약) — 2025-08-31

사용자가 빠르게 확인할 수 있도록, 본 문서 전반의 미체크 항목([ ])만 모아 요약했습니다. 중복 항목은 통합했고, 배포 전 즉시 확인이 필요한 항목과 배포 후로 이월 가능한 항목으로 구분했습니다.

### Blocking(즉시 확인 필요)
- [ ] Backend 컨테이너 내부 `/health` 200 및 `/docs` 노출 확인(1회)
- [ ] Alembic heads 단일성 확인만 수행(`alembic heads -v`) — 업그레이드는 지금 실행 금지
- [ ] `.env.production` 시크릿 교체 확인: JWT_SECRET_KEY, DATABASE_URL/POSTGRES_*, REDIS_PASSWORD, Kafka(KAFKA_*) 키

### 배포 전 준비(가능하면 이번 라운드 수행)
- [ ] 데이터베이스 사전 백업(덤프 저장)
- [ ] Playwright 요약 스모크 0 fail(회원가입/프로필/잔액·하나의 게임·상점 1건·어드민 골드 1건)
- [ ] 프론트 타입 재생성 필요 시 수행 후 컨테이너 `npm run build` 그린 확인

### Defer OK(배포 후 창구)
- [ ] `alembic upgrade head` 실행 및 단일 head 유지 확인(현재는 heads 단일성만 확인하고 연기)
- [ ] 백엔드 핵심 스모크 전체 묶음 0 fail: `test_smoke_health.py`, `test_ci_alembic_guard.py`, `test_schema_drift_guard.py`
- [ ] OpenAPI 재수출(`python -m app.export_openapi`) + drift guard 통과 → 필요 시 `openapi-typescript` 재생성 및 프론트 빌드 확인
- [ ] `/api/games/stats/me` 200 지속성 확인 후 `E2E_REQUIRE_STATS_PARITY=1` 승격
- [ ] 구매 성공 후: 잔액 감소/인벤 증가/이벤트 수신 스펙 활성화(`E2E_SHOP_SYNC=1` → 안정화 후 `E2E_REQUIRE_SHOP_SYNC=1`)
- [ ] `docker-compose.prod.yml` 신설 및 prod 기동/롤백 절차 문서화(개발 볼륨 제거, 자원 제한·헬스체크·모니터링 포함)
- [ ] 모니터링 스택 임계치/알람 튜닝(Prometheus/Grafana)
- [ ] `final.md`에 실행/검증 로그 추가 기록
- [ ] 프론트 프로덕션 모드 SSR 스모크(/, /admin/*) 실행 및 결과 캡처
- [ ] 404 정적 자산/프리패치 점검 체크리스트 수행

