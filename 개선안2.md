# 개선안2.md — 중심 운영 문서(체크현황 포함) + 배포 전 필수 체크리스트

작성일: 2025-08-29
대상 문서: 개선안.md, final.md

본 문서는 현재 기준의 “중심 관리 문서”입니다. 개선안.md와 api docs/20250808.md의 내용을 통합/요약하며, 완료/미완료 상태를 체크박스로 관리합니다.

## 0) 요약 체크상태(최신)

- [x] 서버 권위적 쓰기 전면 withReconcile 적용(슬롯/가챠/RPS/크래시)
- [x] unifiedApi(멱등/백오프/401-refresh) 정착 및 토큰/WS 오리진 정규화
- [x] WS 전역 동기화(프로필/게임/구매 이벤트) 정상 동작
- [x] Admin: 포인트 지급·Shop CRUD(+복구) 구현 및 E2E 통합
- [x] OpenAPI 중복 operation_id 정리, 재수출, drift guard PASS
- [x] 프론트 타입 재생성 및 빌드/ESLint 그린(생성 파일 lint 제외 반영)
- [x] Playwright 컨테이너 E2E: 27 passed / 3 skipped / 0 failed (2025-08-29 재확인)
- [x] Alembic 단일 head 유지 및 /docs 노출 확인
- [x] 프론트 healthcheck 안정화(/healthz 도입 및 글로벌 셋업 반영)
- [x] 백엔드 pytest 핵심 스모크 확장(인증/리프레시/상점 구매 그린)
- [x] 프로필 액션 이력 서버 권위 페이징 통합(중복 제거) 및 E2E 가드 추가
- [x] unifiedApi 로그 게이트(NEXT_PUBLIC_UNIFIEDAPI_LOG) 도입(개발 로그 노이즈 축소)
- [ ] 추가 E2E 보강(회원가입→잔액, 게임합계=API, 구매/인벤, a11y)
- [ ] 프로덕션 compose/secrets 하드닝 및 롤백 절차 문서화
- [ ] OpenAPI 재수출→typegen→빌드 자동화(정기 파이프라인)

## 1) 미완료 항목(두 문서 통합·체크박스)

- 네트워킹/클라이언트
  - [ ] unifiedApi: 429/5xx 백오프 재시도 동작 검증 및 과도 로그 최소화 (로그 게이트 도입됨, 검증 테스트 대기)
  - [ ] RealtimeSyncProvider: 이벤트 타입 매핑(profile_update/purchase_update/reward_granted/game_update) 확인 (스모크 통과, 상세 검증 대기)
  - [ ] RealtimeSyncProvider: 재연결/스로틀/중복 억제(dedupe) 동작 검증 (동작 관찰됨, E2E 보강 대기)
  - [x] 프론트 healthcheck 안정화: /healthz 라우트 추가 및 compose healthcheck 연동(start_period 포함)

- 전역 스토어/초기화
  - [x] selector 사용 가이드 적용(로컬 user 변형 금지 주석 반영) — ESLint 규칙 보완은 진행 중

- 테스트/E2E(Playwright)
  - [x] 프로필 액션 이력 페이지네이션 중복 방지 최소 스펙 추가(action_history_pagination.spec)
  - [ ] 회원가입→로그인→balance 확인 스펙 추가/그린화
  - [ ] 게임 4종 실행 후 UI 합계 = `/games/stats/me` 일치 스펙
  - [ ] 구매 성공 후: 잔액 감소/인벤 증가/이벤트 수신 스펙
  - [ ] 어드민 골드 조정 실시간 반영 스펙(운영 프로파일에서도 보장)
  - [ ] a11y(@axe-core/playwright) 주요 화면 무결성 스펙

- 백엔드 검증 루틴
  - [ ] 컨테이너 내부 `pytest -q app/tests` 그린 수렴(최소 스모크)
  - [ ] `alembic upgrade head` 실행 후 단일 head 유지 확인

- OpenAPI/타입
  - [ ] `python -m app.export_openapi` 재수출 → drift guard 통과 → 필요 시 `openapi-typescript` 재생성 및 프론트 빌드 확인

- 문서/로그
  - [ ] `api docs/20250808.md` 변경 요약 반영
  - [ ] `final.md`에 실행/검증 로그 추가 기록

- 배포/운영 도구
  - [ ] docker-compose.prod.yml 신설(개발 볼륨 제거, prod 헬스체크/리소스 제한/모니터링 프로필 반영)
  - [ ] 모니터링 스택: Prometheus/Grafana 목표 패널·알람 기준 재확인 및 ENV 임계(성공율/지연/보류 스파이크) 튜닝

- 기타(운영 편의)
  - [ ] 프론트 프로덕션 모드 SSR 스모크(/, /admin/*) 실행 및 결과 캡처
  - [ ] 404 정적 자산/프리패치 점검 체크리스트 수행(final.md 부록 지침)

## 2) 배포 전 필수 체크리스트(Blocking Only)

- 보안/환경
  - [ ] .env.production 준비 및 비밀값 교체: JWT_SECRET_KEY, PAYMENT_WEBHOOK_SECRET, POSTGRES_PASSWORD, REDIS_PASSWORD, CORS_ORIGINS(도메인)
  - [ ] Kafka/ClickHouse 사용 여부 확정 및 비활성 시 플래그로 명시(KAFKA_ENABLED=0 등)

- 데이터베이스
  - [ ] 사전 백업 수행(덤프 저장)
  - [ ] 컨테이너 내부 `alembic upgrade head` 실행 → heads 단일 확인

- OpenAPI/타입/빌드
  - [ ] `python -m app.export_openapi` 재수출 → drift guard 통과
  - [ ] 프론트 타입 재생성 필요 시 수행 후 `npm run build`(컨테이너) 그린 확인

- 테스트 스모크(컨테이너)
  - [ ] 백엔드 핵심 스모크(pytest 소범위) 0 fail
  - [ ] Playwright 요약 스모크 0 fail(회원가입/프로필/잔액·하나의 게임·상점 1건·어드민 골드 1건)

- 런타임 헬스
  - [ ] backend `/health` 200, `/docs` 정상 노출
  - [ ] frontend healthcheck 그린(필요 시 /healthz 도입 또는 start_period 상향으로 안정화)
  - [ ] WS 연결/토큰 회전 스모크 1회 확인

- 배포 구성
  - [ ] docker-compose.prod.yml(또는 동등 매니페스트)로 prod 기동: 개발용 볼륨 제거, 자원 제한·헬스체크·모니터링 포함
  - [ ] 롤백 경로/스크립트 준비(이전 이미지 태그로 즉시 전환, DB 백업 복구 절차 문서화)

참고
- 현재 E2E 컨테이너 스위트는 27 passed / 3 skipped / 0 failed(증거 있음). 백엔드 /health 200, Alembic 단일 head 확인. 프론트 healthcheck는 타이밍 이슈로 `unhealthy` 표기 가능 → 배포 전 반드시 안정화.

---

## 변경 요약 / 검증 / 다음 단계

- 변경 요약:
  - 프로필 액션 이력 컴포넌트 도입: 서버 권위적 페이징으로 통합하고 중복 제거, `ProfileScreen`에 통합 반영.
  - Playwright E2E에 `action_history_pagination.spec` 추가(중복 방지·페이지네이션 최소 가드).
  - 프론트 `/healthz` 라우트 추가 및 compose healthcheck/글로벌 셋업 대기 흐름 정비.
  - unifiedApi 로그 게이트(`NEXT_PUBLIC_UNIFIEDAPI_LOG`) 도입으로 개발 환경 과도 로그 노이즈 축소.
  - Admin Points UI 제출 버튼 활성화 로직 단순화 및 Tailwind 플러그인 안전 로딩 유지.
- 검증:
  - 컨테이너 Playwright 재실행 결과 27 passed / 3 skipped / 0 failed(2025-08-29 재확인).
  - `action_history_pagination` 스펙 통과 및 실제 UI 중복 미발생 확인.
  - 글로벌 셋업에서 backend `/health` → frontend `/healthz` 순 대기 정상 동작.
- 다음 단계:
  - unifiedApi 429/5xx 백오프 재시도·로그 억제 동작 테스트 추가 및 그린화.
  - RealtimeSync 이벤트 매핑/재연결/스로틀/중복 억제에 대한 테스트 보강 및 스모크 문서화.
  - ESLint 규칙(로컬 user 변형 금지) 추가 및 규칙 위반 차단.
  - OpenAPI 재수출→typegen→프론트 빌드 자동화 워크플로 추가.
  - 추가 E2E(게임 합계=API, 구매/인벤, a11y 확대) 설계·추가.
  - 프로덕션 compose/secrets 하드닝 및 롤백 절차 문서화.
