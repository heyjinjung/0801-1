# 개선안3 (2025-09 최신 온보딩 & 아키텍처 통합 문서)

## 변경 요약
- 2025년 9월까지의 기술 스택, 운영 패턴, 테스트/동기화/보안/운영 가이드를 일원화하여 신규 온보딩 학습용 통합 문서 신설.
- 기존 `개선안2.md`, `전역동기화_솔루션.md`, `docs/2025005.PROJECT_OVERVIEW_SUMMARY.md` 핵심 내용 재구성 (중복 서술 제거, 단계형 온보딩 섹션 추가).
- 표준 실행/검증 루틴( pytest→alembic→/health→Playwright→문서 반영 )을 Onboarding Quick Start 블록으로 명시.

## 검증 결과
- 소스코드 변경 없음(문서 추가만). Alembic heads(단일: c6a1b5e2e2b1) 유지 전제. 백엔드 /health, 프론트 200 정상(직전 세션 확인).
- 기존 문서 참조 경로/명칭 교차 확인: 오타/깨진 참조 미포함(상대경로 사용 회피, 명칭만 표기).
- 보안/배포 민감 정보(.env.production 실제 값)는 포함하지 않음.

## 다음 단계
1. 온보딩 사용자 피드백 반영(이해도 낮은 섹션 FAQ 보강).
2. OpenAPI→typegen 자동화 워크플로 문서(스케줄/조건) 개선안 적용.
3. 테스트 실패 구간(63 fail) 정리 후 “테스트 안정화 현황” 섹션 주기 업데이트.

---

# 1. 목적 / 문서 포지셔닝
신규/기존 개발자가 가장 빠르게 Casino-Club F2P 전체 구조와 표준 개발 흐름을 학습하도록 하는 "단일 진입점" 문서. 
- 무엇을 먼저 읽나? → 본 문서 → 필요 시 세부 문서(`개선안2.md`, `전역동기화_솔루션.md`, `docs/2025005.PROJECT_OVERVIEW_SUMMARY.md` 등)로 드릴다운.
- 무엇을 절대 놓치면 안 되나? → 실행 루틴 / 동기화 권위 / Alembic 단일 head / 테스트 플래그 / 문서 반영 절차.

# 2. 상위 아키텍처 개요
| 레이어 | 구성요소 | 핵심 책임 | 비고 |
| ------ | -------- | -------- | ---- |
| 프론트엔드 | Next.js 15, React 19, Tailwind v4, Framer Motion, Zustand, React Query | UI/SSR, 상태표준화, Neon Theme, 실시간 반영 | E2E 플래그 기반 스펙 활성/스킵 |
| 백엔드 API | FastAPI, SQLAlchemy, Pydantic v2, Alembic | 도메인 서비스, 인증, 게임 로직, 보상/상점 | 단일 config import: `from app.core.config import settings` |
| 데이터 | PostgreSQL, Redis, (ClickHouse 예정) | 영속/캐시/세그먼트, 랭킹/세션 | Redis: streak, idempotency, rate limit |
| 비동기/이벤트 | Kafka, Celery, APScheduler | 이벤트 스트림, 재시도, 주기 집계, RFM | KAFKA_ENABLED=0 로컬 가드 허용 |
| 모니터링/운영 | Prometheus, Grafana, Sentry, Slack | 지표/알람/에러 추적 | 알람 임계 향후 조정 예정 |
| 테스트/자동화 | Pytest, Playwright, Jest/RTL | 단위/통합/E2E/접근성 | 플래그: E2E_REQUIRE_* 계층적 승격 |

# 3. 실행 플로우(표준 루틴)
1) 컨테이너 상태 확인: `./docker-manage-simple.ps1 status`
2) 백엔드 헬스: `docker exec cc_backend curl -s http://localhost:8000/health`
3) DB 마이그레이션: `docker exec cc_backend alembic upgrade head` (heads 단일성 재확인)
4) 최소 스모크(Pytest): health/docs/alembic/schema drift → PASS 후 기능 테스트 확장
5) 프론트 빌드/헬스: 브라우저 http://localhost:3000 → 200
6) Playwright 요약 스모크 (회원가입/잔액/한 게임) → PASS
7) 문서 반영: `개선안2.md`와 `api docs/20250808.md`에 변경 요약 3블록(변경/검증/다음 단계) 추가

# 4. 동기화 & 권위 원칙 (요약)
| 도메인 | 권위 소스 | 주요 엔드포인트 | 캐시/실시간 | 비고 |
| ------ | -------- | --------------- | ---------- | ---- |
| 프로필 | DB(User) | /api/auth/me | WS profile_update | 단일 사용자 식별/랭크 |
| 잔액(Gold) | DB(User.cyber_tokens) | /api/users/balance | WS purchase_update / reward_granted | 금전 연산 후 즉시 재조회 원칙 |
| 게임 통계 | 집계 테이블/서비스 | /api/games/stats/me | WS stats_update (계획) | 응답 포맷 `{success, stats}` 고정 예정 |
| 가챠/보상 | 트랜잭션+로그 | /api/gacha/pull /api/rewards/... | WS reward_granted | 멱등성 키/중복 차단 |
| 세그먼트/RFM | 배치(RFM), Redis | /api/users/segment | 배치 후 캐시 | APScheduler 주기 |

핵심: 프론트는 로컬 추정치 계산 금지, 모든 최종 값은 서버 응답 또는 syncAfterGame 재조회 결과로 확정.

# 5. 테스트 전략 (플래그 기반)
| 플래그 | 의미 | 승격 조건 | 기본값 |
| ------ | ---- | -------- | ------ |
| E2E_REQUIRE_STATS_PARITY | UI=API 게임합계 필수 | /games/stats/me 안정 2회 + UI 파리티 3회 연속 | 0 |
| E2E_SHOP_SYNC / E2E_REQUIRE_SHOP_SYNC | 상점 잔액/인벤 동기화 스펙 | 구매/WS 토스트 포함 3회 PASS | 0 |
| E2E_REALTIME_MAPPING / REQUIRE_REALTIME | Realtime 이벤트 매핑 엄격 | dev emit 라우터 안정 + dedupe PASS | 0 |
| QUICK_SMOKE | 최소 Pytest 스모크만 | 로컬 빠른 피드백 | 1 (선택) |
| TEST_DISABLE_LIFESPAN | FastAPI lifespan 우회 | APScheduler+watchfiles 교착 회피 | 1 (테스트 컨텍스트) |

Pytest 핵심 가드: Alembic 단일 head, OpenAPI drift, health/docs. 실패 → 코드 수정 전 문서 반영 지연.

# 6. 보안/인증 핵심 정책
- JWT + 단일 세션(회전) → 로그아웃/블랙리스트 반영 시 즉시 무효화.
- ALLOW_UNVERIFIED_DEP_FALLBACK=0 (기본) → 테스트/개발에서만 1 허용.
- Webhook/결제(예정) HMAC + timestamp/nonce + event_id 멱등.
- Rate Limit/Fraud: 단위 시간(5분) 내 시도 수/카드 토큰 다양성 기준 차단 정책.
- Secrets 관리: `.env.production` 커밋 금지, rotate-secrets 스크립트 도입 예정.

# 7. 데이터/RFM & 개인화 흐름
1) user_actions / shop_transactions / reward_logs 누적
2) 야간 배치(RFM): recency/frequency/monetary 계산 → user_segments 반영
3) Redis 캐시 최신 세그먼트 → 추천/미션/보상 분기
4) 요청 시 `/recommend/personalized` (미구현 시 stub) → 행동 로그 기반 가중치 모델(확장 지점)

# 8. 비동기 & 이벤트 설계
- Kafka: 고용량 이벤트 스트림(선택적 비활성: KAFKA_ENABLED=0)
- Celery: 즉시 태스크(보상 지급 후 추가 처리, 이메일 등)
- APScheduler: RFM, pending 결제 void, stale 세션/토큰 정리
- Redis Pub/Sub (선택): 경량 실시간 신호 (WS broadcast)

# 9. 프론트엔드 구조 핵심 패턴
- GlobalStore + useGlobalSync + unwrapStats() → 데이터 권위 일관성.
- unifiedApi: 재시도(429/5xx), 무토큰 GET skip, dev-guard 경고.
- 컴포넌트 게임 로직: 서버 응답 후 syncAfterGame 호출 필수.
- data-testid 규칙: `stats-total-<game>`, `games-stats-total`, `balance-gold` 등 E2E 안정화.

# 10. 성능 & 모니터링
| 영역 | 지표 | 도구 | 목표 |
| ---- | ---- | ---- | ---- |
| 백엔드 | p95 latency, error_rate | Prometheus + Grafana | p95 < 300ms |
| 게임 | action throughput, reward latency | Custom metrics → Prometheus | <1s 보상 반영 |
| DB | slow queries (>200ms) | pg_stat_statements | 0.5% 미만 |
| 프론트 | LCP, CLS, TTFB | Lighthouse | LCP < 2.5s |
| 오류 | JS/백엔드 exceptions | Sentry | 회귀 zero-tolerance |

# 11. 배포/롤백 표준
1) main merge → CI: pytest smoke + Playwright smoke + OpenAPI drift
2) prod compose: `docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d`
3) /health & /docs 200, Playwright 요약 스모크 0 fail
4) 문제 발생 시 이전 이미지 태그 재기동(롤백) + DB 백업 복구 시나리오 적용

# 12. 온보딩 Quick Start (신규 개발자)
| 단계 | 목적 | 실행/확인 |
| ---- | ---- | -------- |
| 1 | 레포 클론 | git clone (사내용) |
| 2 | 환경 파일 | .env.development 생성(샘플 복사) |
| 3 | 컨테이너 기동 | `./docker-manage-simple.ps1 start --tools` |
| 4 | 상태 확인 | `./docker-manage-simple.ps1 status` (모두 Healthy) |
| 5 | 백엔드 헬스 | http://localhost:8000/health 200 |
| 6 | 프론트 헬스 | http://localhost:3000 200 |
| 7 | Pytest 스모크 | 최소 health/docs/Alembic PASS |
| 8 | Playwright 스모크 | signup/balance PASS |
| 9 | 문서 읽기 | 본 문서 → 개선안2 → 전역동기화_솔루션 |
| 10 | 첫 기여 | 작은 테스트 수정 또는 주석 개선 PR |

# 13. 향후 로드맵 (요약)
| 카테고리 | 작업 | 상태 |
| -------- | ---- | ---- |
| 테스트 안정화 | 63 failing tests 수렴 | 진행 필요 |
| Realtime 확장 | stats_update 이벤트/파이프라인 | 예정 |
| OpenAPI 자동화 | export→typegen→build CI 파이프라인 | 초안 문서화 |
| 개인화 모델 | churn/LTV 예측(XGBoost 등) | 설계 초안 |
| 보안 강화 | secret rotation script + 2FA admin | 예정 |
| 모니터링 | 알람 임계/슬로우쿼리 자동 분석 | 예정 |

# 14. FAQ (요약)
Q. 왜 로컬에서 Kafka 오류가 보이나?  
A. 테스트 환경에서 KAFKA_ENABLED=0 플래그 미설정 시 consumer thread 시도 → env 플래그 확인.

Q. /api/games/stats/me 포맷이 다르게 오는데?  
A. `{success, stats}`가 표준. 과거 루트 본문 fallback은 unwrapStats()로 임시 지원 → 곧 제거 예정.

Q. 새 게임 추가 시 체크?  
A. 서비스/모델/라우터 1파일씩 추가, games.py 라우터 통합 원칙 준수, 멱등/로그/테스트(성공+엣지) 동반.

Q. Alembic 다중 head 발생 시?  
A. 원인 리비전 파악 → merge 리비전 생성 → 문서 변경 요약 기록 → 테스트 재실행.

# 15. 부록(심화 문서 링크 명칭)
- 개선안2.md (변경 히스토리/문제 해결 로그)
- 전역동기화_솔루션.md (동기화/권위 체계 상세)
- docs/2025005.PROJECT_OVERVIEW_SUMMARY.md (확장형 운영/인프라 종합)
- docs/2025004.GAME_SERVICE_STRUCTURE.md (게임 도메인 상세)
- docs/2025006.user_segmentation_personalization.md (세그먼트/RFM)
- docs/2025008.reward_gacha_mission_optimization.md (보상/가챠 최적화)

---

## 유지 관리 수칙
1. 본 문서 수정 시 "변경 요약/검증/다음 단계" 블록 최상단 갱신.
2. 백엔드 구조/동기화/테스트 정책 변동 → 개선안2.md & api docs/20250808.md도 동시 갱신.
3. OpenAPI 스키마 변경 → export + typegen + 프론트 빌드 통과 후 본 문서 로드맵 반영.

---

(끝)
