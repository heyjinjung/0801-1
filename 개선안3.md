# 개선안3 (2025-09 최신 온보딩 & 아키텍처 통합 문서)

## 변경 요약 (2025-09-26 SSR Random 2차 정리 & 서버 권위 설계 초안 반영)
### 변경 요약
- Python 기반 SSR Random 정적 검사 → Node ESM 스크립트로 전환 (`check_hydration_random.mjs`), 테스트/스토리 디렉토리 자동 제외로 노이즈 감소.
- `unifiedApi.ts` / `sync.ts` UUID 생성 `Math.random` 제거 → `crypto.randomUUID`(+getRandomValues fallback) 적용, fallback 은 시간+카운터(비난수)로 SSR 결정성 확보.
- `useUserManager.tsx` 초기 사용자 시드 생성 로직 결정화(닉네임 해시 + flags seed → stable RNG)로 Hydration 불일치 제거.
- 남은 시각 효과용 `Math.random` 위치 전수 재분류(P1/P2) 및 처리 전략/액션 플랜(섹션 15) 문서화.
- Gacha / Slot 서버 권위 전환 설계 초안(섹션 16) 작성: 엔드포인트, 데이터 모델, 멱등/seed echo, 모니터링, 단계적 마이그레이션 정의.

### 검증 결과
- 핵심 로직 계층(unifiedApi / sync / user manager) grep 결과 `Math.random(` 직접 호출 0 (주석 문자열 제외) 가정.
- 결정화된 RNG 적용 후 SSR 경로에서 사용자 초기 상태/UUID 생성 비결정성 제거 예상(빌드 스캐너 경고 감소).
- 문서 변경만으로 백엔드(Alembic head 단일), OpenAPI 스키마 영향 없음. 향후 CI 통합 시 Node 스캐너 exit code 기반 FAIL 승격 계획 유지.

### 다음 단계
1. P1 컴포넌트(LoadingScreen/HomeDashboard/SignupScreen/ShopScreen/Notification/Toast) 순차 처리: `use client` 또는 stableRandom 적용 + crypto ID 치환.
2. Gacha/Slot 서버 Stub 구현(`pull`, `pull10`, `slot/spin`) 후 Mock→실 계산 전환 단계(섹션 16.9) 착수.
3. CI 파이프라인에 `npm run check:ssr-random -- --json` 아티팩트 업로드 + 경고→실패 임계 승격(T+2 계획) 및 측정 로그 개선안2.md prepend.

---

> TL;DR (Onboarding 60초)
> 1) `./docker-manage-simple.ps1 start --tools` → 2) `./docker-manage-simple.ps1 status` (모두 Healthy) → 3) `docker exec cc_backend alembic heads` == 1 → 4) `docker exec cc_backend pytest -q tests/ -k health` (스모크 PASS) → 5) http://localhost:8000/docs & /health 200 → 6) Playwright 스모크(`docker compose run --rm playwright npx playwright test --project=chromium --grep @smoke`) → 7) 변경 시: 코드 → 테스트 → 문서(개선안2.md 변경 블록 prepend) 순. 실패 시 문서 선행 수정 금지.
> 핵심 3대 규칙: (A) 게임 라우터는 항상 `app/routers/games.py` 단일 유지 (추가 X) (B) 설정 import는 `from app.core.config import settings` 만 사용 (config.py 확장 금지) (C) 테스트 실행 표준 순서(Pytest→Alembic→/health→/docs→Playwright) 어기지 않기.
> 목표: 첫 로컬 성공(Helath+Docs) < 5분, Hydration/Schema Drift 0, Alembic heads 1 유지.

> 실행 계획 (T 기준 = 2025-09-26)
> - T+1: Slot/Gacha/Crash 초기 SSR random 제거 (stableRandom + useEffect defer) 착수
> - T+2: check_hydration_random CI Gate WARN→FAIL 승격 및 Toast ID 결정화
> - T+3: Gacha 확률/Slot 결과 서버 권위 전환 설계 초안 문서화


## 변경 요약 (2025-09-26 Hydration Randomness 인벤토리 추가)
### 변경 요약
- SSR 초기 렌더 시 잠재적 Hydration mismatch를 유발하는 `Math.random()` / 가변 ID 생성 패턴 전수 스캔 결과를 분류(시각 효과 / 게임 로직 / ID/토스트 / 유저 초기화)하여 18A 섹션 신설.
- 위험도(P1~P3) 및 처리 전략(Seed + Stable Snapshot / Pooled Reuse / Client-only Deferral / Server Authority Move) 정의로 후속 리팩터 순서 결정.
- 기존 Particles 메모리 풀(18절)과 연계: 시각 효과 계층 표준 전략을 문서에 명시하여 코드 리뷰 가이드라인 마련.

### 검증 결과
- 코드 미변경(문서 추가). 기존 `particles.ts` 풀/seed 패턴과 충돌 없음. Alembic heads 단일성/ OpenAPI 스키마 영향 없음.
- grep 기반 식별(>200 hits 중 비SSR 실행 영역 제외) 수작업 필터링으로 P1 집합 8개 항목 확정.
- React 19 Hydration 경고 규칙(변수 입력: Date.now/Math.random) 리스트와 교차 확인: P1 항목 모두 초기 SSR DOM 생성 가능 위치.

### 다음 단계
1. P1 (LoadingScreen, HomeDashboard 배경, GameDashboard 배경 파티클, SignupScreen 초기 effect, Gacha Static Sparkles, Slot/Coin Drops 첫 mount, Notification/Toast ID if pre-hydration push, UnifiedApi uuidv4 초기 호출 가능 경로) 순서대로 Seed Snapshot + Lazy Rehydrate 적용.
2. 공통 유틸 `stableRandom(seed:number, i?:number)` / `makeDeterministicArray(len, seed)` 도입 후 기존 특화 구현 점진 교체.
3. CI 정적 검사 스크립트(`scripts/check_hydration_random.py`) 추가: `.tsx` SSR 경로에서의 직접 `Math.random(` 패턴 검출 + 허용 주석(`// @allow-ssr-random`) 가드.

---

> 권위 선언 (Authoritative Baseline)
> 본 문서는 2025-09-26 시점 Casino-Club F2P 기술/운영/품질 표준의 단일 기준서입니다. 중복/상충 내용 발견 시 본 문서가 우선하며, 세부 근거는 `개선안2.md`(히스토리)와 `전역동기화_솔루션.md`(심화 동기화), `docs/2025005.PROJECT_OVERVIEW_SUMMARY.md`(확장 인프라)를 참고합니다. 모든 구조/정책 변경은 본 문서 상단 "변경 요약/검증/다음 단계" 블록에 신규 항으로 prepend 후 관련 참조 문서 동기화가 완료되어야 합니다.

## 버전 & 개정 이력 규칙
| 버전 | 날짜 | 성격 | 주요 범위 | 코멘트 |
| ---- | ---- | ---- | -------- | ------- |
| v1.0 | 2025-09-26 | Baseline 확립 | 온보딩/아키텍처/체크리스트 통합 | 기존 산재 문서 요약 + 격상 |
| v1.x | (추가) | Minor | 비파괴 규칙/체크리스트/FAQ 보강 | 테스트/문서만 영향 |
| v2.0 | (예약) | Major | 구조적 변경 (예: Realtime 통합 레이어, 인증 확장) | 마이그레이션 동반 가능 |

개정 프로세스: (1) 변경 제안 PR → (2) 최소 테스트/문서 영향 분석 → (3) 본 문서 상단 블록 prepend → (4) 참조 문서 경로 점검(OpenAPI drift 포함) → (5) Merge.

## KPI / 목표 지표 (지속 리뷰)
| 카테고리 | 지표 | 정의 | 목표(초기) | 데이터 소스 | 리뷰 주기 |
| -------- | ---- | ---- | ---------- | ----------- | --------- |
| 안정성 | Test Pass Rate | CI Pytest + Playwright 합산 통과율 | ≥ 95% (→ 100%) | CI 로그 | Daily |
| Schema 일관 | Alembic Head 단일성 | heads 출력 count | == 1 | alembic heads | On-change |
| 성능(백엔드) | p95 API Latency | 주요 read/write 엔드포인트 p95 | < 300ms | Prometheus | Weekly |
| 경제 Loop | Reward Reflection Time | 행동→잔액/UI 반영 지연 | < 1s | 로그 + Prom | Weekly |
| 개인화 | RFM Daily Coverage | 전 사용자 대비 RFM 계산 반영율 | ≥ 99% | 배치 로그 | Daily |
| 프론트 UX | Hydration Mismatch Count | 빌드/SSR 대비 mismatch 개수 | 0 | Next.js 빌드 로그 | On-change |
| 보안 | JWT Revocation Latency | 블랙리스트 반영~401 응답 평균 | < 3s | Auth 로그 | Weekly |
| 문서 | Drift Incidents | 코드와 문서 상충(검증 실패) 발생 | 0 / 월 | 리뷰 태그 | Monthly |

> 핵심 규칙 (반드시 숙지)
> 1. Games Router 단일화: 신규/수정 게임 엔드포인트는 모두 `app/routers/games.py`에 병합. 별도 gacha.py 등 생성 금지.
> 2. Settings Import 표준: 백엔드 전역 환경 접근은 `from app.core.config import settings` 외 패턴 불허(레거시 config.py 확장 금지, 제거 예정).
> 3. 테스트 실행 순서: Pytest 스모크(health/docs + heads) → Alembic upgrade head 재확인 → /health & /docs 수동 확인 → Playwright 스모크 → 문서 변경 prepend. 순서 역행 시 Drift/RCA 문서화 우선.


KPI 갱신 실패(목표 미달) 시: (a) RCA 24h 내 공유 (b) 개선안2.md에 사고/조치 로그 추가 (c) 본 문서 KPI 표 목표/주석 조정 여부 결정.

## 변경 요약 (v1.0 Baseline)
- 2025년 9월까지의 기술 스택, 운영 패턴, 테스트/동기화/보안/운영 가이드를 일원화하여 신규 온보딩 학습용 통합 문서 신설.
- 기존 `개선안2.md`, `전역동기화_솔루션.md`, `docs/2025005.PROJECT_OVERVIEW_SUMMARY.md` 핵심 내용 재구성 (중복 서술 제거, 단계형 온보딩 섹션 추가).
- 표준 실행/검증 루틴( pytest→alembic→/health→Playwright→문서 반영 )을 Onboarding Quick Start 블록으로 명시.

## 검증 결과 (v1.0)
- 소스코드 변경 없음(문서 추가만). Alembic heads(단일: c6a1b5e2e2b1) 유지 전제. 백엔드 /health, 프론트 200 정상(직전 세션 확인).
- 기존 문서 참조 경로/명칭 교차 확인: 오타/깨진 참조 미포함(상대경로 사용 회피, 명칭만 표기).
- 보안/배포 민감 정보(.env.production 실제 값)는 포함하지 않음.

## 다음 단계 (Baseline 이후 즉시)
1. 온보딩 사용자 피드백 반영(이해도 낮은 섹션 FAQ 보강).
2. OpenAPI→typegen 자동화 워크플로 문서(스케줄/조건) 개선안 적용.
3. 테스트 실패 구간(63 fail) 정리 후 “테스트 안정화 현황” 섹션 주기 업데이트.
4. Hydration Mismatch 전체 스캔 결과 잔여 컴포넌트 목록화 → 제거 ETA 확정.
5. Particles 메모리 풀(getPooledPoints) 도입 → 프론트 재랜더 비용 측정(전/후 p95 ms).

---

# 1. 목적 / 문서 포지셔닝
신규/기존 개발자가 가장 빠르게 Casino-Club F2P 전체 구조와 표준 개발 흐름을 학습하도록 하는 "단일 진입점" 문서. 
- 무엇을 먼저 읽나? → 본 문서 → 필요 시 세부 문서(`개선안2.md`, `전역동기화_솔루션.md`, `docs/2025005.PROJECT_OVERVIEW_SUMMARY.md` 등)로 드릴다운.
- 무엇을 절대 놓치면 안 되나? → 실행 루틴 / 동기화 권위 / Alembic 단일 head / 테스트 플래그 / 문서 반영 절차.

# 2. 상위 아키텍처 개요
| 레이어 | 구성요소 | 핵심 책임 | 비고 |
| ------ | -------- | -------- | ---- |
| 프론트엔드 | Next.js 15, React 19, Tailwind v4, Framer Motion, Zustand, React Query | UI/SSR, 상태표준화, Neon Theme, 실시간 반영 | E2E 플래그 기반 스펙 활성/스킵 |
| 백엔드 API | FastAPI, SQLAlchemy, Pydantic v2, Alembic | 도메인 서비스, 인증, 게임 로직, 보상/상점 | 단일 config import: `from app.core.config import settings` |
| 데이터 | PostgreSQL, Redis, (ClickHouse 예정) | 영속/캐시/세그먼트, 랭킹/세션 | Redis: streak, idempotency, rate limit |
| 비동기/이벤트 | Kafka, Celery, APScheduler | 이벤트 스트림, 재시도, 주기 집계, RFM | KAFKA_ENABLED=0 로컬 가드 허용 |
| 모니터링/운영 | Prometheus, Grafana, Sentry, Slack | 지표/알람/에러 추적 | 알람 임계 향후 조정 예정 |
| 테스트/자동화 | Pytest, Playwright, Jest/RTL | 단위/통합/E2E/접근성 | 플래그: E2E_REQUIRE_* 계층적 승격 |

# 3. 실행 플로우(표준 루틴)
상단 TL;DR와 동일하나 컨텍스트 명확화를 위해 재요약 (중복 단계 세부는 TL;DR 참조):
1. Start & Status → 2. Alembic heads==1 & upgrade head → 3. Pytest 스모크(health/docs/schema) → 4. /health & /docs 수동 확인 → 5. Playwright 스모크 (@smoke) → 6. 문서 prepend (개선안2.md + 필요 시 api docs/20250808.md) → 7. 확장 테스트/기능 개발.
Deviation 발생 시(어떤 단계 실패): 코드 수정 < 문서 성공/실패 로그 기록(개선안2.md) < 재실행 순으로 대응.

# 4. 동기화 & 권위 원칙 (요약)
| 도메인 | 권위 소스 | 주요 엔드포인트 | 캐시/실시간 | 비고 |
| ------ | -------- | --------------- | ---------- | ---- |
| 프로필 | DB(User) | /api/auth/me | WS profile_update | 단일 사용자 식별/랭크 |
| 잔액(Gold) | DB(User.cyber_tokens) | /api/users/balance | WS purchase_update / reward_granted | 금전 연산 후 즉시 재조회 원칙 |
| 게임 통계 | 집계 테이블/서비스 | /api/games/stats/me | WS stats_update (계획) | 응답 포맷 `{success, stats}` 고정 예정 |
| 가챠/보상 | 트랜잭션+로그 | /api/gacha/pull /api/rewards/... | WS reward_granted | 멱등성 키/중복 차단 |
| 세그먼트/RFM | 배치(RFM), Redis | /api/users/segment | 배치 후 캐시 | APScheduler 주기 |

핵심: 프론트는 로컬 추정치 계산 금지, 모든 최종 값은 서버 응답 또는 syncAfterGame 재조회 결과로 확정.

# 5. 테스트 전략 (플래그 기반)
| 플래그 | 의미 | 승격 조건 | 기본값 |
| ------ | ---- | -------- | ------ |
| E2E_REQUIRE_STATS_PARITY | UI=API 게임합계 필수 | /games/stats/me 안정 2회 + UI 파리티 3회 연속 | 0 |
| E2E_SHOP_SYNC / E2E_REQUIRE_SHOP_SYNC | 상점 잔액/인벤 동기화 스펙 | 구매/WS 토스트 포함 3회 PASS | 0 |
| E2E_REALTIME_MAPPING / REQUIRE_REALTIME | Realtime 이벤트 매핑 엄격 | dev emit 라우터 안정 + dedupe PASS | 0 |
| QUICK_SMOKE | 최소 Pytest 스모크만 | 로컬 빠른 피드백 | 1 (선택) |
| TEST_DISABLE_LIFESPAN | FastAPI lifespan 우회 | APScheduler+watchfiles 교착 회피 | 1 (테스트 컨텍스트) |

Pytest 핵심 가드: Alembic 단일 head, OpenAPI drift, health/docs. 실패 → 코드 수정 전 문서 반영 지연.

# 6. 보안/인증 핵심 정책
- JWT + 단일 세션(회전) → 로그아웃/블랙리스트 반영 시 즉시 무효화.
- ALLOW_UNVERIFIED_DEP_FALLBACK=0 (기본) → 테스트/개발에서만 1 허용.
- Webhook/결제(예정) HMAC + timestamp/nonce + event_id 멱등.
- Rate Limit/Fraud: 단위 시간(5분) 내 시도 수/카드 토큰 다양성 기준 차단 정책.
- Secrets 관리: `.env.production` 커밋 금지, rotate-secrets 스크립트 도입 예정.

# 7. 데이터/RFM & 개인화 흐름
1) user_actions / shop_transactions / reward_logs 누적
2) 야간 배치(RFM): recency/frequency/monetary 계산 → user_segments 반영
3) Redis 캐시 최신 세그먼트 → 추천/미션/보상 분기
4) 요청 시 `/recommend/personalized` (미구현 시 stub) → 행동 로그 기반 가중치 모델(확장 지점)

# 8. 비동기 & 이벤트 설계
- Kafka: 고용량 이벤트 스트림(선택적 비활성: KAFKA_ENABLED=0)
- Celery: 즉시 태스크(보상 지급 후 추가 처리, 이메일 등)
- APScheduler: RFM, pending 결제 void, stale 세션/토큰 정리
- Redis Pub/Sub (선택): 경량 실시간 신호 (WS broadcast)

# 9. 프론트엔드 구조 핵심 패턴
- GlobalStore + useGlobalSync + unwrapStats() → 데이터 권위 일관성.
- unifiedApi: 재시도(429/5xx), 무토큰 GET skip, dev-guard 경고.
- 컴포넌트 게임 로직: 서버 응답 후 syncAfterGame 호출 필수.
- data-testid 규칙: `stats-total-<game>`, `games-stats-total`, `balance-gold` 등 E2E 안정화.

# 10. 성능 & 모니터링
| 영역 | 지표 | 도구 | 목표 |
| ---- | ---- | ---- | ---- |
| 백엔드 | p95 latency, error_rate | Prometheus + Grafana | p95 < 300ms |
| 게임 | action throughput, reward latency | Custom metrics → Prometheus | <1s 보상 반영 |
| DB | slow queries (>200ms) | pg_stat_statements | 0.5% 미만 |
| 프론트 | LCP, CLS, TTFB | Lighthouse | LCP < 2.5s |
| 오류 | JS/백엔드 exceptions | Sentry | 회귀 zero-tolerance |

# 11. 배포/롤백 표준
1) main merge → CI: pytest smoke + Playwright smoke + OpenAPI drift
2) prod compose: `docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d`
3) /health & /docs 200, Playwright 요약 스모크 0 fail
4) 문제 발생 시 이전 이미지 태그 재기동(롤백) + DB 백업 복구 시나리오 적용

# 12. 온보딩 Quick Start (신규 개발자)
| 단계 | 목적 | 실행/확인 |
| ---- | ---- | -------- |
| 1 | 레포 클론 | git clone (사내용) |
| 2 | 환경 파일 | .env.development 생성(샘플 복사) |
| 3 | 컨테이너 기동 | `./docker-manage-simple.ps1 start --tools` |
| 4 | 상태 확인 | `./docker-manage-simple.ps1 status` (모두 Healthy) |
| 5 | 백엔드 헬스 | http://localhost:8000/health 200 |
| 6 | 프론트 헬스 | http://localhost:3000 200 |
| 7 | Pytest 스모크 | 최소 health/docs/Alembic PASS |
| 8 | Playwright 스모크 | signup/balance PASS |
| 9 | 문서 읽기 | 본 문서 → 개선안2 → 전역동기화_솔루션 |
| 10 | 첫 기여 | 작은 테스트 수정 또는 주석 개선 PR |

# 13. 향후 로드맵 (요약)
| 카테고리 | 작업 | 상태 |
| -------- | ---- | ---- |
| 테스트 안정화 | 63 failing tests 수렴 | 진행 필요 |
| Realtime 확장 | stats_update 이벤트/파이프라인 | 예정 |
| OpenAPI 자동화 | export→typegen→build CI 파이프라인 | 초안 문서화 |
| 개인화 모델 | churn/LTV 예측(XGBoost 등) | 설계 초안 |
| 보안 강화 | secret rotation script + 2FA admin | 예정 |
| 모니터링 | 알람 임계/슬로우쿼리 자동 분석 | 예정 |
| 게임 서버 권위 | Slot/Gacha 결과 서버 계산 전환 | 설계 초안 추가 |

# 14. FAQ (요약)
Q. 왜 로컬에서 Kafka 오류가 보이나?  
A. 테스트 환경에서 KAFKA_ENABLED=0 플래그 미설정 시 consumer thread 시도 → env 플래그 확인.

Q. /api/games/stats/me 포맷이 다르게 오는데?  
A. `{success, stats}`가 표준. 과거 루트 본문 fallback은 unwrapStats()로 임시 지원 → 곧 제거 예정.

Q. 새 게임 추가 시 체크?  
A. 서비스/모델/라우터 1파일씩 추가, games.py 라우터 통합 원칙 준수, 멱등/로그/테스트(성공+엣지) 동반.

Q. Alembic 다중 head 발생 시?  
A. 원인 리비전 파악 → merge 리비전 생성 → 문서 변경 요약 기록 → 테스트 재실행.

---

# 15. 잔여 시각 효과 Random 분류 (2025-09-26 후속 정리)
프론트엔드 `components/` 내 잔여 `Math.random` 사용 위치를 SSR 영향 기준으로 재분류. 목표: 서버 렌더 경로(SSR)에 남는 비결정적 호출 0. 스캐너는 `use client` 지정 파일을 예외 처리하므로, 아래 표에서 "Client-Only 지시자 추가" 옵션은 빠른 차단책.

| 파일 | 라인 패턴 예시 | 성격 | 현재 SSR 포함 가능성 | 처리 전략 | 우선순위 |
|------|----------------|------|-----------------------|------------|----------|
| `components/LoadingScreen.tsx` | x/y/size/duration | 순수 시각 로딩 파티클 | (App shell 진입 시 SSR 가능) | 1) 파일 상단 `use client`; 2) 또는 seed + stableRandom (재현 필요 시) | P1 |
| `components/HomeDashboard.tsx` | 배경 points(x/y/size/opacity) | 배경 데코 | 일부 섹션 SSR 경로 포함 | seed + stableRandom + 메모이즈(SSR 결정 후 CSR 재생성 지연) | P1 |
| `components/InventoryScreen.tsx` | onboarding 애니메이션 좌표 | 비핵심 효과 | 주 컨텐츠 이하 (SSR 영향 낮음) | `use client` 선언 (간단) | P2 |
| `components/NotificationSystem.tsx` | id 생성(Math.random.toString) | 토스트 ID (멱등/접근성) | 초기 마운트에서 이벤트 push 시 영향 | crypto.randomUUID()로 교체 (fallback seed) | P1 |
| `components/NotificationToast.tsx` | id 생성 | 토스트 단건 | 동일 | 상동 (crypto.randomUUID) | P1 |
| `components/StreamingScreen.tsx` | viewers 변동/파티클(x,y) | 시뮬레이션(데모) | 데모 모드 SSR 가능성 → 낮음 | `use client` + mock seed (E2E 플래그) | P2 |
| `components/ui/Sidebar.tsx` | 높이/위치 퍼센트 | 장식 UI | SSR 경로 포함 가능 | seed + stableRandom 또는 고정 배열 | P2 |
| `components/SignupScreen.tsx` | 배경 파티클 좌표 | 시각 효과 | 초기 진입 SSR 경로 | `use client` + stableRandom(optional) | P1 |
| `components/ShopScreen.tsx` | id fallback, 배경 좌표 | 상점 목록 | SSR 가능 | id: crypto.randomUUID / 좌표: seed stableRandom | P1 |

추가: Gacha Sparkles / Particles 는 이미 `utils.ts` 에서 stableRandom 기반으로 치환 완료 (Date.now seed → 후속 서버 seed echo 전환 예정).

## 15.1 액션 플랜
| Step | 작업 | 출력 | 완료 조건 |
|------|------|------|-----------|
| 1 | P1 컴포넌트에 `use client` 또는 stableRandom 적용 | 수정 PR | 빌드 시 스캐너 위반 0 |
| 2 | ID 생성(Math.random) → crypto.randomUUID 치환 | 변경 diff | Notification/Shop/Toast 전부 교체 |
| 3 | HomeDashboard 배경 seed 결정화 + 재렌더 최소화 | util 함수 | SSR=CSR 좌표 동일 확인 |
| 4 | ShopScreen 좌표/ID 결정화 | 수정 PR | E2E shop 잔여 스냅샷 안정 |
| 5 | Sidebar/Streaming/Inventory 잔여 P2 일괄 처리 | 배치 커밋 | 스캐너/grep 잔여 0 |
| 6 | Gacha/Slot 서버 권위 설계 적용(다음 절 참조) | 아키텍처 문서 | 서버 seed echo API 준비 |

지표 모니터: Hydration mismatch 로그(React 19) + E2E first paint 안정(스크롤 점프/레이아웃 변동 없음) → 개선안2.md 블록에 측정값 기록.

# 16. Gacha / Slot 서버 권위 전환 설계 초안 (Draft)
목표: 모든 확률/결과 계산을 서버에서 수행하여 (1) 예측/변조 방지 (2) 로그/분석 정확도 확보 (3) 프론트 단순화 (4) 일관된 재현성(멱등 키 + seed echo) 보장.

## 16.1 핵심 요구사항
- 멱등성: 클라이언트 재시도(네트워크 오류, 중복 클릭) 시 동일 결과 재전달.
- 투명성: 응답에 `server_seed`, `client_seed_fragment(옵션)`, `rolls[]`, `outcome[]` 포함.
- 감사 추적: 모든 pull/spin 행위는 atomic 트랜잭션 + 로그 테이블 기록(`gacha_pulls`, `slot_rounds`).
- 보상 정합: 인벤토리/잔액 증가는 동일 트랜잭션 내 커밋; 실패 시 롤백.
- 속도: p95 < 180ms (Redis 캐시 활용) / 초당 ≥ 50 req 단일 인스턴스 처리 목표.

## 16.2 엔드포인트 초안
| 게임 | 메서드/경로 | 요청 본문 | 응답 | 멱등키 | 노트 |
|------|-------------|----------|------|--------|------|
| Gacha Pull(1회) | POST `/api/games/gacha/pull` | `{banner_id, idem_key?}` | `{pull_id, server_seed, rarity, item, rolls:[...], inventory_delta, balance_after}` | X-Idempotency-Key 헤더 또는 body.idem_key | banner 설정/확률 서버 캐시 |
| Gacha Pull(10회) | POST `/api/games/gacha/pull10` | `{banner_id, idem_key?}` | `{pull_id, server_seed, results:[{rarity,item}], summary, inventory_delta, balance_after}` | 동일 | 내부 루프 + 단일 트랜잭션 |
| Slot Spin | POST `/api/games/slot/spin` | `{bet_amount, idem_key?}` | `{round_id, server_seed, reels:[[sym...]], line_wins:[{line, amount}], total_win, balance_after}` | 동일 | RTP 조정 파라미터 포함 가능 |
| Slot Config 조회 | GET `/api/games/slot/config` | - | `{reels, paytable, volatility, version}` | - | CDN 캐시 가능 |

## 16.3 데이터 모델 (Alembic 예정)
```sql
-- gacha_pulls
id BIGSERIAL PK
user_id BIGINT FK users.id
banner_id VARCHAR(64)
idem_key VARCHAR(64) UNIQUE
server_seed BIGINT NOT NULL
rarity VARCHAR(16) NOT NULL
item_id VARCHAR(64) NOT NULL
rolls JSONB NOT NULL            -- 예: [12,87,303]
reward_payload JSONB NOT NULL   -- 획득 아이템/수량
gold_delta INT DEFAULT 0
created_at TIMESTAMPTZ DEFAULT now()
latency_ms INT

-- slot_rounds
id BIGSERIAL PK
user_id BIGINT FK users.id
bet_amount INT NOT NULL
idem_key VARCHAR(64) UNIQUE
server_seed BIGINT NOT NULL
reels JSONB NOT NULL            -- [["A","K","Q"], ...]
line_wins JSONB NOT NULL        -- [{line:1,amount:30,symbol:"A"}]
total_win INT NOT NULL
gold_delta INT NOT NULL         -- (total_win - bet_amount)
created_at TIMESTAMPTZ DEFAULT now()
latency_ms INT
volatility_snapshot JSONB       -- 해당 시점 RTP/volatility 파라미터
```

인덱스: `(user_id, created_at DESC)`, `(idem_key)` UNIQUE, `banner_id`(선택), partial index on recent timeframe for purge.

## 16.4 처리 흐름 (예: Gacha Pull)
1. 입력 검증(banner 존재/활성, 사용자 잔액 ≥ 비용) → 비용 차감 (동시성: SELECT ... FOR UPDATE 사용자 잔액)
2. 멱등키 조회: idem_key 있으면 기존 row 즉시 반환 (reward 재계산 금지)
3. server_seed 생성: `randbits(64)` 또는 Crypto RNG → rolls 계산 (가중치 테이블 캐시)
4. 희귀도/아이템 결정 → reward payload 구성
5. 인벤토리/잔액 업데이트 + gacha_pulls INSERT (latency_ms 기록)
6. commit 후 WS 이벤트 `reward_granted` 브로드캐스트 (payload: pull_id, gold_delta 등)
7. 응답: seed + roll trace + 결과/보상 + 최종 잔액.

Slot Spin 동일 구조: bet 검증 → 멱등/seed → reels 배열 결정(Fisher-Yates or precomputed strip rotation) → 라인 승수 계산 → 보상 적용/로그.

## 16.5 Seed Echo & 재현성
프론트는 server_seed + 공개 파라미터(reel strips, probability table)를 이용해 선택적으로 로컬 재연산(검증 모드) 가능. 불일치 시 개발 모드에서 경고 로그 출력(향후 Cheating Detection Hook 기초).

## 16.6 멱등 & 오류 모드
| 상황 | 서버 동작 | 반환 | 재시도 영향 |
|------|-----------|------|-------------|
| idem_key 중복(이미 성공) | 기존 row 조회 | 200 기존 결과 | 안전 (중복 클릭) |
| 잔액 부족 | 롤백 | 400 `INSUFFICIENT_FUNDS` | 사용자 잔액 증가 후 재시도 OK |
| banner 비활성 | 롤백 | 400 `BANNER_INACTIVE` | 수정 후 재시도 |
| 내부 오류(예: DB 장애) | 롤백 | 500 | 클라이언트 재시도(동일 idem_key) 시 중복 생성 없음 |
| timeout 직후 commit 성공 | 다음 재시도 idem_key 조회로 안전 | 200 기존 결과 | 중복 보상 없음 |

## 16.7 캐시 / 성능 전략
- 배너 확률 테이블: Redis hash + local in-process LRU (TTL 60s) → DB 접근 감소.
- Slot paytable / reel strips: 앱 기동 시 preload + hot reload(ADMIN 업데이트 이벤트) WS 수신 시 invalidate.
- 통계 집계: 배치 or materialized view (optional). 실시간 UI는 최근 N pull/round fetch.

## 16.8 모니터링 & 메트릭
| 메트릭 | 태그 | 설명 |
|--------|-----|------|
| gacha_pull_latency_ms | banner_id, rarity | Pull 처리 end-to-end 시간 |
| slot_spin_latency_ms | volatility | Spin 처리 시간 |
| gacha_rarity_dist | rarity | 최근 X분 희귀도 빈도 (카운터) |
| slot_rtp_window | window=5m | 최근 구간 RTP (수익율) |
| idem_key_reuse | type=gacha/slot | 멱등 재사용 카운트 |
| reward_ws_delay_ms | type | commit→WS 송신 지연 |

## 16.9 단계적 마이그레이션
| 단계 | 내용 | 프론트 상태 | 서버 상태 |
|------|------|-------------|------------|
| 0 | 문서화(본 초안) | 기존 클라이언트 계산 | 없음 |
| 1 | 서버 엔드포인트 Stub (결과 mock + seed echo) | 옵션 플래그로 사용 | DB 로그 테이블 생성 |
| 2 | 실제 확률/결과 계산 서버 이전 | 기본 서버 사용, 클라 fallback 경고 | 로직/로그 완성 |
| 3 | 클라이언트 로컬 계산 코드 제거 | 검증/리플레이만 유지 | 운영 튜닝(RTP/확률 핫스왑) |
| 4 | Cheating Detection Hook 추가 | 재현 모드 비교 | 이상 통계 알림 |

## 16.10 리스크 & 대응
| 리스크 | 설명 | 대응 |
|--------|------|------|
| 서버 부하 증가 | 모든 결과 서버 경로 통과로 QPS 상승 | 캐시, 수평 확장, 비동기 offload |
| 멱등 충돌 | idem_key 생성 규칙 충돌 가능 | UUIDv4(crypto) + UNIQUE 인덱스, 재시도 조회 |
| seed 누출 악용 | seed로 내부 알고리즘 역추적 | 내부 가중치 난독화, 결과 subset만 공개 |
| 로그 폭증 | 고QPS 시 테이블 급팽창 | 파티셔닝 + TTL/Archive (Timescale/partman) |
| latency 스파이크 | 확률 계산/락 경합 | 배너 캐시 + 락 범위 최소화 (금액 행만) |

---

# 15. 부록(심화 문서 링크 명칭)
- 개선안2.md (변경 히스토리/문제 해결 로그)
- 전역동기화_솔루션.md (동기화/권위 체계 상세)
- docs/2025005.PROJECT_OVERVIEW_SUMMARY.md (확장형 운영/인프라 종합)
- docs/2025004.GAME_SERVICE_STRUCTURE.md (게임 도메인 상세)
- docs/2025006.user_segmentation_personalization.md (세그먼트/RFM)
- docs/2025008.reward_gacha_mission_optimization.md (보상/가챠 최적화)

---

## 유지 관리 수칙
1. 본 문서 수정 시 "변경 요약/검증/다음 단계" 블록 최상단 갱신.
2. 백엔드 구조/동기화/테스트 정책 변동 → 개선안2.md & api docs/20250808.md도 동시 갱신.
3. OpenAPI 스키마 변경 → export + typegen + 프론트 빌드 통과 후 본 문서 로드맵 반영.

## 16. 표준 체크리스트 (운영 관점)
### 16.1 Daily Checklist
- [ ] `./docker-manage-simple.ps1 status` Healthy
- [ ] Alembic `heads` == 1
- [ ] Error Rate (24h) < SLA (Sentry/Grafana 대시보드)
- [ ] 실패 테스트 재시도 후 잔여 fail == 0 (아니면 RCA 작성)
- [ ] KPI 테이블 목표 미달 항목 없음 (있으면 개선안2.md 사건 로그)

### 16.2 Pre-Change (기능/스키마 수정 전)
- [ ] 변경 영향 범위 정의(코드/스키마/테스트/문서)
- [ ] 중복 라우터/모델/마이그레이션 생성 여부 사전 검색(grep)
- [ ] Alembic 단일 head 재확인
- [ ] OpenAPI drift 예상 여부 판단
- [ ] 보안 키/비밀 노출 우려 검토

### 16.3 Post-Change (PR 전 / Merge 전)
- [ ] Pytest -q (QUICK_SMOKE 비활성 시 전체 중요 스위트)
- [ ] alembic upgrade head & heads==1 재확인
- [ ] /health 200, /docs 스키마 로드 성공
- [ ] OpenAPI export & typegen(필요 시)
- [ ] Playwright 스모크 PASS
- [ ] 본 문서 상단 블록 prepend 완료
- [ ] 개선안2.md 변경 로그 동기화
- [ ] 린트/포맷/타입체크 (frontend/backend)

## 17. 위험 & 롤백 전략
| 위험 | 트리거 | 즉시 대응 | 롤백 절차 | 사후 조치 |
| ---- | ------ | --------- | --------- | --------- |
| 다중 Alembic head | 동시 revision 생성 | merge revision 계획 수립 | merge revision 적용 → 재검증 | 재발 방지 가이드 개선 |
| 인증 대량 401 | JWT 서명/시간 설정 오류 | 환경 변수 재확인/재배포 | 이전 이미지 재기동 | 토큰 재발급 가이드 공지 |
| Hydration 대량 mismatch | SSR 랜덤/브라우저 API 직접 사용 | 문제 컴포넌트 client-only 전환 | 직전 태그 프론트 배포 복구 | 컴포넌트 패턴 문서화 |
| RFM 배치 누락 | 스케줄러 예외/작업 지연 | 수동 실행(APScheduler 재시작) | 스케줄 스크립트 재배포 | 모니터링 알람 한계 조정 |
| OpenAPI Drift | 스키마 변경 미 export | 즉시 export + diff 리뷰 | 이전 commit revert | export CI Gate 강화 |
| Fraud 임계 미차단 | Rate limit 설정 누락 | Redis / config 값 재적용 | Hotfix revert | 임계 자동화 규칙 추가 |

## 18. Particles 및 Hydration 개선 계획 (세부)
| 항목 | 현황 | 목표 | 측정 방법 | ETA |
| ---- | ---- | ---- | -------- | --- |
| SSR Random 제거 커버리지 | 핵심 화면 처리 (Login/Home) | 100% | Next build 로그 + 수동 diff | 2025-10 W1 |
| Particles 메모리 풀 | 미구현 | 객체 재활용 & GC 감소 | React Profiler commit time | 2025-09 W4 |
| Animation Frame Budget | 미측정 | < 8ms (평균) | Performance Tab | 2025-10 W2 |
| Idle 초기 렌더 FID | 기본 | 개선 (지연 로딩) | Lighthouse | 2025-10 W2 |

### 18A. Hydration Randomness 잔여 제거 인벤토리
| 그룹 | 컴포넌트/파일 (발췌) | 현재 패턴 | SSR 노출 | 위험도 | 처리 전략 | 비고 |
| ----- | -------------------- | --------- | -------- | -------- | ---------- | ---- |
| 시각효과(P1) | `components/LoadingScreen.tsx` | 초기 렌더 배열 내 `Math.random()` N회 | 가능(app router loading) | P1 | Seed Snapshot → mount 후 pooled 재할당 | 첫 진입 스플래시 |
| 시각효과(P1) | `components/HomeDashboard.tsx` 배경 포인트 | useState 초기 random | 가능 | P1 | 이미 부분 시드, seed util로 통일 | 잔여 window 의존 제거 |
| 시각효과(P1) | `components/GameDashboard.tsx` (빌드 산출물 page.js 내) | inline random coords | 가능(첫 SSR) | P1 | 구조 분리 + stable points | page 레벨 *@refactor |
| 시각효과(P1) | `components/SignupScreen.tsx` effect 포인트 | window 기반 random | 경로에 따라 | P1 | seed + client diff | 모바일 진입 영향 |
| 게임이펙트(P1) | `games/gacha/components.tsx` sparkles/particles | 다수 random 위치/delay | 일부 SSR | P1 | Seed + schedule 재생성 | 결과 연출 안정 필요 |
| 게임이펙트(P1) | `NeonSlotGame` (page.js 번들) | generateParticles/coinDrops random | 가능 | P1 | 서버 권위 값/seed + pooling | 잭팟/코인 덮어쓰기 방지 |
| 게임이펙트(P1) | `NeonCrashGame` getRandomValue | stub true 분기 | 가능 | P1 | 서버 결과 도착 전 seed fallback | 그래프 초기 프레임 |
| ID생성(P1) | Toast/Notification/Feedback uuid | Date.now+random 조합 | 초기 push 가능 | P1 | Lazy mount 후 생성 / stable prefix | 첫 렌더 시 미발생 보장 필요 |
| 인터벌(P2) | `StreamingScreen` viewers delta | setInterval random | 초기 DOM 영향 적음 | P2 | 첫 SSR 0 seed → client diff | 값 표시는 서버 fetch 후 |
| 인터벌(P2) | Hearts/heartParticles | mount 시 random coords | client-only 의도 | P2 | ensure client-only wrapper | `useEffect` 위치 고정 |
| 로직(P2) | Gacha 확률/아이템 선택 | 클라 random | 서버 권위 아님 | P2 | 서버 API 확률 계산 전환 | 추적/로그 필요 |
| 로직(P2) | Slot 심볼 가중치 | 클라 random | SSR UI 영향 낮음 | P2 | 서버 spin 결과 + 클라 애니메이션 분리 | Fraud 방지 |
| 유저초기값(P3) | `useUserManager.tsx` gold/level 등 random | 로컬 테스트 헬퍼 | P3 | 테스트 전용 seed 주입 | prod 분기 구분 |
| 번들내(정보) | React/Framer 내부 random (dev) | 라이브러리 내부 | 불가 | N/A | 제외(허용 리스트) | 환경 한정 |

정의: 위험도 P1 = 초기 SSR DOM 자체가 변동 가능 / P2 = 초기 DOM은 고정이나 빠른 후속 hydration delta 흔함 / P3 = 테스트·로컬 전용 또는 사용자 비가시.

표준 처리 전략 요약:
1) Seed Snapshot: `stableRandom(seed)`를 통해 길이/좌표/ID 결정 → SSR & CSR 동일 출력.
2) Pooled Reuse: 시각 효과 배열을 풀에서 취득 후 mount 이후만 변환.
3) Client-only Deferral: `useEffect`에서만 random 수행하고 SSR에는 placeholder 유지.
4) Server Authority Move: 게임 결과/보상 확률 계산은 서버 API 응답으로 확정, 클라 random은 연출 한정.

추가 가드:
- 허용 불가 패턴: 파일 상위 레벨 `Math.random()` 호출, JSX inline 즉시 평가 random.
- 허용 주석 (`// @allow-ssr-random`) 적용 시 CI 경고 무시(점진적 제거 한정). 

### 18C. Slot / Gacha 서버 권위 전환 설계 (초안)
목표: 확률/결과/보상 계산을 100% 백엔드에서 결정 → 클라이언트는 연출 및 후처리(UI)만 수행. Fraud / 리플레이 / 예측 가능성 제거.

#### A. 공통 설계 원칙
1. 멱등성: 모든 스핀/풀 요청은 `X-Idempotency-Key` 헤더 필수. 재시도 시 동일 결과 반환.
2. 서버 결정 필드: 결과 심볼/아이템 배열, 승리 금액, 잭팟 여부, 멀티플라이어, 잔액 스냅샷.
3. 클라이언트 계산 금지: (a) payline 평가, (b) rarity 가중치, (c) 보상 합산. → 문서화된 API 스키마 기준.
4. 감사 로깅: raw 난수 seed, 결과 배열, 계산된 payout, 사용자 이전/이후 잔액, latency(ms) 저장.
5. 재현성: 분쟁 발생 시 seed + deterministic RNG(서버 내부)로 재시뮬레이션 가능.

#### B. 엔드포인트 (초안)
| 리소스 | 메서드 | 경로 | 요청 | 응답 (핵심 필드) | 주석 |
| ------ | ------ | ---- | ---- | ---------------- | ---- |
| Slot Spin | POST | `/api/games/slot/spin` | `{ bet_amount }` | `{ success, reels: string[][], win_amount, is_jackpot, multiplier, balance, server_seed, payout_breakdown }` | 기존 대비 server_seed / breakdown 추가 |
| Gacha Pull | POST | `/api/games/gacha/pull` | `{ pull_count }` | `{ success, items:[{name,rarity,tier}], rare_item_count, ultra_rare_item_count, balance, server_seed }` | rarity 사전 정의 enum 고정 |
| RNG Audit | GET | `/api/games/audit/{id}` | – | `{ seed, created_at, type, input, output_hash }` | 내부/관리자 전용 |
| Jackpot Pool | GET | `/api/games/slot/jackpot` | – | `{ current, last_win: { amount, ts, user_id } }` | 캐시 1s |

#### C. 서버 내부 흐름 (Slot 예시)
1. 요청 수신 → 입력 검증 (bet 범위, 사용자 잔액 ≥ bet)
2. Redis 멱등 키 SETNX(idem) → 실패 시 기존 결과 즉시 반환
3. 사용자 잔액 차감 (트랜잭션 시작)
4. RNG 시드 생성: `seed = hash(user_id + server_time_ns + secure_rand())`
5. 결정적 RNG(Legacy LCG 또는 PCG)로 심볼 3개 생성 + wild 변형 규칙 적용
6. payline 평가 → payout 계산 → 잭팟 조건 평가 → jackpot pool 업데이트(원자적)
7. 사용자 잔액 += payout (있다면)
8. 게임 로그 + 감사 테이블 insert (seed, reels, payout, pre_balance, post_balance)
9. 커밋 → 캐시(예: jackpot pool) 갱신
10. 응답 반환 (심볼 배열 + 금액 + seed 해시(원시 seed 노출 X))

#### D. 서버 내부 흐름 (Gacha 예시)
1. 입력 검증 (pull_count ∈ {1,10}, 잔액 ≥ 비용)
2. Redis 멱등 SETNX
3. 비용 차감
4. 시드 생성 → 배너 확률표(가중) 순회해 pull_count 만큼 아이템 추출
5. 희귀도 카운트 계산(epic/ultra) → pity(천장) 규칙 반영(선택)
6. 인벤토리/로그 insert (아이템, rarity, seed hash)
7. 잔액 스냅샷 저장 후 커밋
8. 응답: items[], rare_item_count, ultra_rare_item_count, balance, server_seed(hash)

#### E. 데이터 모델(추가 테이블 초안)
| 테이블 | 주요 컬럼 | 설명 |
| ------ | -------- | ---- |
| game_slot_spin_log | id, user_id, seed_hash, reels_json, bet, payout, jackpot, pre_balance, post_balance, created_at | Slot 감사/재현 |
| game_gacha_pull_log | id, user_id, seed_hash, items_json, pulls, rare_count, ultra_count, cost, pre_balance, post_balance, created_at | Gacha 감사/통계 |
| jackpot_pool | id(=slot), current_amount, last_win_amount, last_win_user_id, updated_at | 잭팟 상태 |
| rng_audit (옵션) | id, seed_hash, game_type, raw_seed_encrypted, created_at | seed 암호화 저장 |

#### F. 마이그레이션/배포 순서
1. Alembic migration: 신규 로그 / jackpot_pool 테이블 추가 (head 단일 유지)
2. 서버 로직: 기존 spin/pull 엔드포인트에 seed/breakdown 필드 추가(클라 backward compatible 처리)
3. 클라이언트: server_seed 있으면 로컬 random 경로 disable 후 애니메이션만
4. 점진적 전환: 2주간 dual-path (server result > fallback local) 로그로 fallback 비율 수집
5. fallback 비율 < 0.1% & 오류율 기준 충족 → 로컬 시뮬레이션 코드 제거

#### G. 클라이언트 수정 체크리스트
- [ ] NeonSlotGame: `generateSpinResult` 제거, serverResult 실패시에만 유지
- [ ] GachaSystem: `getRandomItem` / local 10-pull 루프 제거, serverUsed 실패시에만 사용
- [ ] 잔액/통계 반영: server 응답 balance 우선 + syncAfterGame 보조
- [ ] UI 연출: reels/particles는 deterministic placeholder 후 server 결과 적용
- [ ] 테스트: 가챠/슬롯 멱등 재시도(동일 idemKey 요청 두 번 → 동일 결과) 스펙 추가

#### H. 위험 & 완화
| 위험 | 설명 | 완화 |
| ---- | ---- | ---- |
| latency 증가 | 서버 계산/로그로 응답 지연 | 비동기 로그 batch, 캐시 jackpot | 
| 멱등 키 충돌 | 키 재사용시 잘못된 재생 | UUID v7 + TTL 1h, SETNX 실패시 fetch path |
| seed 유출 | 클라 seed 노출 → 예측 | seed_hash만 응답, raw_seed 암호 저장 |
| fallback 과다 | 서버 오류 빈번 → 로컬 결과 남용 | 오류율 모니터, 5xx>1% 시 롤백 플래그 |

#### I. KPI 연동
- Jackpot 서버 권위 전환 후: Jackpot payout mismatch 0
- Gacha 희귀도 분포: 계획 대비 χ² p-value > 0.05 유지
- Slot fallback rate: <0.1% (rolling 24h)
- 에러율: spin/pull 5xx < 0.5%

#### J. 다음 단계 (Implementation Slice)
1. Alembic migration 초안 작성 (game_slot_spin_log, game_gacha_pull_log)
2. 백엔드 서비스 레이어 draft: SlotSpinService, GachaPullService (payout calc / weighting)
3. 클라이언트 guard 플래그: SERVER_AUTH_SLOT=1, SERVER_AUTH_GACHA=1 (기본 on, env로 off)
4. 멱등 재시도 Pytest + 가챠/슬롯 E2E 추가
5. fallback usage 메트릭(log counter) 대시보드 노출


### 18B. stableRandom 유틸 사용 가이드 (신규)
목적: SSR↔CSR 결정적 렌더 보장 및 랜덤 기반 시각 효과/게임 연출을 seed 기반으로 표준화.

#### 제공 API
| 함수 | 시그니처 | 설명 | 주사용 사례 |
| ---- | -------- | ---- | ----------- |
| `createStableRng(seed)` | `(seed:number)=>{next(),int(max),pick(arr)}` | 경량 LCG 상태 RNG | 연속 난수/배열 선택 |
| `stableRandom(seed, index)` | `(seed:number,index:number)=>number` | 인덱스 기반 단발 결정 난수 | 좌표/딜레이 i번째 고정 |
| `stableShuffle(arr, seed)` | `(T[],seed)=>T[]` | Fisher–Yates 결정 셔플 | 초기 symbol/order 고정 |

#### 패턴별 적용
| 기존 패턴 | 문제 | 교체 예시 |
| -------- | ---- | -------- |
| `const pts=[...Array(n)].map(()=>Math.random())` | SSR/CSR 불일치 | `const rng=createStableRng(seed); const pts=[...Array(n)].map(()=>rng.next())` |
| JSX `{Math.random()>0.5 && <Spark/>}` | 트리 분기 | mount 후 useEffect 조건/또는 seed 기반 결정값 캐시 |
| 즉시 coin drop 좌표 random | Hydration diff 가능 | seed snapshot → effect 재배치(pooled) |
| 게임 결과 random (클라) | 보안/공정성 | 서버 결과 API → 클라 연출에만 stableRandom |

#### 도입 로드맵 (T 기준: 오늘)
| T+일 | 작업 | 세부 |
| ---- | ---- | ---- |
| T+1 | Slot/Gacha 초기 render random 제거 | seedSnapshot + effect 재할당 |
| T+2 | Crash 초기 그래프 점 stableRandom | getRandomValue 대체, 서버 결과 대기 시 seed fallback |
| T+3 | Toast/Notification ID 안정 | 최초 SSR 시 생성 지연, mount 후 rng.pick(prefixes) |
| T+4 | StreamingScreen viewers delta | 첫 SSR 0, effect에서 rng.next 적용 |
| T+5 | CI Gate FAIL 승격 | 현재 경고 상태 → 위반 시 오류 처리 |

#### 권장 코드 스니펫 (참고)
```ts
import { createStableRng, stableShuffle } from '@/lib/stableRandom';

const SEED = 73; // 컴포넌트 prop 또는 상위 context로 주입 추천
const rng = createStableRng(SEED);
const points = Array.from({length: 24}, () => ({
	x: rng.next(),
	y: rng.next(),
	delayMs: Math.floor(rng.next()*800)
}));

// 결정적 순서 섞기 (예: 심볼 배열)
const symbols = stableShuffle(['A','B','C','D','E'], SEED+11);
```

#### 주의
- seed는 UX 동일성/테스트 재현성을 위해 상수 또는 사용자/세션 파생값으로 명확히 결정.
- 보안 민감(확률/결과) 로직은 stableRandom 사용 금지 → 서버 authoritative.
- 허용되지 않는 위치: 모듈 최상위에서 즉시 rng.next() 반복 실행(빌드 타임 변동). 반드시 함수/컴포넌트 내부에서 최초 호출.



## 19. 문서 드리프트 감시 (제안)
자동화 초안:
1) CI Job: OpenAPI export 후 git diff → 변경 존재 & 상단 블록 미수정 시 FAIL.
2) Alembic heads!=1 시 즉시 FAIL.
3) Hydration mismatch grep 정적 분석(SSR 출력에 Math.random / Date.now 발견) → 경고/차후 FAIL 승격.

## 20. 용어(Glossary) 보강
| 용어 | 정의 | 비고 |
| ---- | ---- | ---- |
| Drift | 코드와 문서/스키마 간 불일치 | 탐지/차단 대상 |
| Baseline | 현재 공식 기준 상태 | 변경 블록 상단행 |
| Prepend | 상단에 신규 변경 블록 추가 | Append 금지 |
| RFM | Recency Frequency Monetary | 세그먼트 계산 기준 |
| Seeded Random | SSR 일관성 위한 고정 시드 난수 | Hydration 안정 |
| Idempotency Pre-Lock | Redis 키 선점으로 중복 실행 차단 | 구매/보상 흐름 |

---

"Baseline" 이후 모든 변경은 상단 블록 prepend 및 KPI 영향 평가가 선행되어야 합니다.

---

(끝)
